import{Utility}from"./GCA_Utilities.js";class PopupDialog{constructor(dialogName,title,content,container,config){this.dialogName=dialogName;dialogName=Utility.htmlToElem(`<div id="${this.dialogName}-dialog" title="${title}" tabindex="-1">${content}</div>`);container.appendChild(dialogName),config?(this.dialog=$(`#${this.dialogName}-dialog`).dialog(config),this.setDialogTitle(title)):this.title=title,this.init()}configDialog(config,autoclose=!0){this.dialog=$(`#${this.dialogName}-dialog`).dialog(config),this.dialog.on("dialogopen",this.setClickHandler.bind(this)),autoclose&&(parent=this.dialog[0].parentNode||this.dialog[0].parentElement,Number.isInteger(autoclose)?parent.addEventListener("mouseleave",this.close.bind(this,autoclose)):parent.addEventListener("mouseleave",this.close.bind(this)))}setClickHandler(){let widget=this.dialog.dialog("widget")[0];widget.onclick=this.handleClick.bind(this);for(var el of $(widget).find(".ui-dialog-titlebar-close"))el.tabIndex=-1}handleClick(e){e.stopPropagation()}setDialogTitle(title){this.title=title,(this.dialog||$(`#${this.dialogName}-dialog`)).dialog({title:title})}close(delay=0){0==delay?this.dialog.dialog("close"):setTimeout(this.close.bind(this,0),delay)}}class InfoPopup extends PopupDialog{constructor(name,title,content,container){super(name,title,content,container),this.configDialog({autoOpen:!1,hide:"fade",show:"blind",buttons:{Close:this.close.bind(this)}})}close(){this.item=null,this.onclose&&(this.onclose(),this.onclose=null),this.dialog.dialog("close")}open(item,target=null,onclose=null){this.onclose=onclose,this.item===item?this.close():(this.item=item,target&&(onclose=target.getBoundingClientRect(),this.dialog.dialog({position:{of:window,my:"left top",at:`left+${onclose.left+1} top+`+(onclose.bottom+1),collision:"fit fit"}})),this.showContent(item),this.dialog.dialog("open"))}}class MessagePopup extends InfoPopup{constructor(container){super("message-popup","3D Model",' <label id="alert-message" class="text popup-data"></label>',container)}init(){this.message=$("#alert-message")[0]}showContent(message){this.message.textContent=message}}class ModelPopup extends InfoPopup{constructor(container,title="GCA model"){super("model-popup",title,` <label for="model-name" class="label" >Name:</label>
						<label id="model-name" class="text popup-data"></label>
						<p/>
						<label class="label">Version:</label>
						<label id="model-version" class="text popup-data"></label>
						<p/>
						<label class="label">Species:</label>
						<label id="model-species" class="text popup-data"></label>
						<p/>

						<label class="label">Owner:</label>
						<label id="model-owner" class="text popup-data"></label>
						<p/>
						
						<label class="label">Description:</label>
						<label id="model-desc" class="text popup-data"></label>
						<p/>
						
						<label class="label">Contact:</label>
						<a id="model-contact" href=""></a>
						<label id="model-contact" class="text popup-data"></label>`,container)}open(item,target=null,onclose=null){this.setDialogTitle("GCA "+(item.type||"")+" Model"),super.open(item,target,onclose)}init(){this.name=$("#model-name")[0],this.version=$("#model-version")[0],this.desc=$("#model-desc")[0],this.owner=$("#model-owner")[0],this.species=$("#model-species")[0],this.contact=$("#model-contact")[0]}showContent(model){this.name.textContent=model.name,this.version.textContent=model.version,this.desc.textContent=model.description||model.name,this.owner.textContent=model.owner,this.species.textContent=model.species,this.contact.href="mailto:"+model.contact,this.contact.textContent=model.contact}}const CORS_Allowed=!0;let clamp=(val,b1,b2)=>b1<b2?val<b1?b1:b2<val?b2:val:val<b2?b2:b1<val?b1:val,capitalizeFirst=string=>string.toLowerCase().replace(/(^\w|\s\w)/g,m=>m.toUpperCase()),getCurrentScriptPath=function(level=0){let location=(new Error).stack.split("\n")[1].split("@").pop(),lastIndex=location.lastIndexOf("/"),path="";for(0<lastIndex&&(path=location.substr(0,lastIndex));0<level&&0<lastIndex;)0<(lastIndex=path.lastIndexOf("/",lastIndex))&&(path=path.substr(0,lastIndex)),level--;return path};class Utility{static condenseText(text,width){let str=text.text();if(text.length()>width&&(text.attr("word-spacing","-1px"),text.length()>width&&(text.attr("letter-spacing","0px"),text.length()>width))){text.attr("letter-spacing","-0.2px");let i=0;for(;text.length()>width;){if(i>str.length/4)return!1;str=str.substr(0,str.length-1),text.text(str),i++}}return!0}static relativePos(e,isGroup=!1){let target=e.target||e.srcElement;isGroup=(target=isGroup?target.parentNode||target.parentElement:target).getBoundingClientRect();return{x:e.clientX-isGroup.left-1,y:e.clientY-isGroup.top-1}}static handleClicks(singleClickCallback,doubleClickCallback,...args){Utility.clickTimer?(clearTimeout(Utility.clickTimer),Utility.clickTimer=null,doubleClickCallback(...args)):Utility.clickTimer=setTimeout(function(){singleClickCallback(...args),Utility.clickTimer=null},200)}static colorBlend(col1,col2,p=.5){let usePound=!1;"#"==col1[0]&&(col1=col1.slice(1),usePound=!0),"#"==col2[0]&&(col2=col2.slice(1));var col2=parseInt(col2,16),p2=1-p,r2=clamp(Math.round((col2>>16)*p2),0,255),g2=clamp(Math.round((col2>>8&255)*p2),0,255),col2=clamp(Math.round((255&col2)*p2),0,255),p2=parseInt(col1,16);let r=clamp(Math.round((p2>>16)*p+r2),0,255),g=(r=(r<16?"0":"")+r.toString(16),clamp(Math.round((p2>>8&255)*p+g2),0,255)),b=(g=(g<16?"0":"")+g.toString(16),clamp(Math.round((255&p2)*p+col2),0,255));return b=(b<16?"0":"")+b.toString(16),(usePound?"#":"")+r+g+b}static colorShade(col,shade){let usePound=!1;"#"==col[0]&&(col=col.slice(1),usePound=!0);col=parseInt(col,16);let r=clamp(Math.round((col>>16)*shade),0,255),g=(r=(r<16?"0":"")+r.toString(16),clamp(Math.round((col>>8&255)*shade),0,255)),b=(g=(g<16?"0":"")+g.toString(16),clamp(Math.round((255&col)*shade),0,255));return b=(b<16?"0":"")+b.toString(16),(usePound?"#":"")+r+g+b}static addElement(parent,tag,id,className,prepend=!1){let element=document.createElement(tag);return element.id=id,prepend?parent.prepend(element):parent.append(element),className&&(element.className=className),element}htmlToElems(html){let temp=document.createElement("template");return temp.innerHTML=html,temp.content.childNodes}static addStyle(selector,rules){let style=document.createElement("style");return style.type="text/css",document.getElementsByTagName("head")[0].appendChild(style),(style.sheet||{}).insertRule?style.sheet.insertRule(selector+" {"+rules+"}",0):(style.styleSheet||style.sheet).addRule(selector,rules),style.sheet.rules[0]}static getStyle(selector){for(var styleSheet of document.styleSheets){var rule;for(rule of styleSheet.rules||styleSheet.cssRules)if(rule.style===selector)return rule}}static htmlToElem(html){let temp=document.createElement("template");return html=html.trim(),temp.innerHTML=html,temp.content.firstChild}static innerDimensions=element=>{var computedStyle=getComputedStyle(element),height=element.clientHeight,element=element.clientWidth;return{height:(height-=parseFloat(computedStyle.paddingTop)+parseFloat(computedStyle.paddingBottom))-(parseFloat(computedStyle.marginTop)+parseFloat(computedStyle.marginBottom)),width:(element-=parseFloat(computedStyle.paddingLeft)+parseFloat(computedStyle.paddingRight))-(parseFloat(computedStyle.marginLeft)+parseFloat(computedStyle.marginRight))}};static innerHeight=element=>{var computedStyle=getComputedStyle(element),element=element.clientHeight;return(element-=parseFloat(computedStyle.paddingTop)+parseFloat(computedStyle.paddingBottom))-(parseFloat(computedStyle.marginTop)+parseFloat(computedStyle.marginBottom))};static innerWidth=element=>{var computedStyle=getComputedStyle(element),element=element.clientWidth;return(element-=parseFloat(computedStyle.paddingLeft)+parseFloat(computedStyle.paddingRight))-(parseFloat(computedStyle.marginLeft)+parseFloat(computedStyle.marginRight))};static fetchShim(){if(CORS_Allowed&&-1!=navigator.userAgent.indexOf("Chrome")&&/^file:\/\/\//.test(location.href)){let orig=fetch;window.fetch=resource=>/^[^/:]*:/.test(resource)?orig(resource):new Promise(function(resolve,reject){let request=new XMLHttpRequest,fail=error=>{reject(error)},pull=(["error","abort"].forEach(event=>{request.addEventListener(event,fail)}),expected=>new Promise((resolve,reject)=>{request.responseType==expected||"text"==expected&&!request.responseType?resolve(request.response):reject(request.responseType)}));request.addEventListener("load",()=>resolve({arrayBuffer:()=>pull("arraybuffer"),blob:()=>pull("blob"),text:()=>pull("text"),json:()=>pull("json")})),request.open("GET",resource.replace(/^\//,"./")),request.send()})}}static loadJson(url){let obj=void 0,req=new XMLHttpRequest;return req.open("GET",url,!1),req.overrideMimeType("text/html"),req.send(null),obj=200===req.status?JSON.parse(req.responseText):obj}static getCurrentScriptLocation(){return(new Error).stack.split("\n")[1].split("@").pop()}static getCurrentScriptPath(level=0){let location=Utility.getCurrentScriptLocation(),lastIndex=location.lastIndexOf("/"),path="";for(0<lastIndex&&(path=location.substr(0,lastIndex));0<level&&0<lastIndex;)0<(lastIndex=path.lastIndexOf("/",lastIndex))&&(path=path.substr(0,lastIndex)),level--;return path}static addStylesheet(ref){if(null!=ref){let link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=ref,document.head.appendChild(link)}}}class Sidebar{constructor(container,pos,id,content,width,delay=.5){switch(this.collapsedWidth="6px",this.id=id,this.container=container,this.position=pos.trim().toLowerCase(),this.content=content,this.width="number"==typeof width?width+"px":width,this.isCollapsed=!0,this.sidebar=Utility.htmlToElem(`<div id="${this.id}" class="sidebar"><div id="${this.id}_wrapper"> ${this.content}</div></div>`),this.sidebar.onmouseenter=this.open.bind(this),this.sidebar.onmouseleave=this.close.bind(this),this.container.appendChild(this.sidebar),this.wrapper=document.getElementById(this.id+"_wrapper"),this.sidebar.style.width=this.width,this.sidebar.style.opacity="0",this.delay=delay,this.posDelay=` ${this.delay}s`,this.position){case"left":this.sidebar.style.right=`calc(100% - ${this.collapsedWidth})`;break;case"right":this.sidebar.style.left=`calc(100% - ${this.collapsedWidth})`}this.isActive=!0}toggleSidebar1(){this.isCollapsed?this.open():this.close()}setSidebarCollapse(collapse){if(this.isActive){var pos=collapse?`calc(100% - ${this.collapsedWidth})`:`calc(100% - ${this.width})`;switch(this.position){case"left":this.sidebar.style.transition="right"+this.posDelay,this.sidebar.style.right=pos;break;case"right":this.sidebar.style.transition="left"+this.posDelay,this.sidebar.style.left=pos}this.sidebar.style.transition+=collapse?`, opacity ${2*this.delay}s`:", opacity 0s",this.sidebar.style.opacity=collapse?"0":"0.8",this.isCollapsed=collapse}}open(){this.onopen&&this.onopen(),this.setSidebarCollapse(!1)}close(){this.onclose&&this.onclose(),this.setSidebarCollapse(!0)}hold(){this.sidebar.onmouseenter=this.sidebar.onmouseleave=null}unhold(){this.sidebar.onmouseenter=this.open.bind(this),this.sidebar.onmouseleave=this.close.bind(this)}setActive(status){status||this.isCollapsed||this.toggleSidebar(),this.isActive=status}setOnopen(onopen){this.onopen=onopen}setOnclose(onclose){this.onclose=onclose}}class GutAnatomy{loadJsonAnatomy(url){return GutAnatomy.visibleIntstinalLayers=["Serosa","Muscularis","Submucosa","Mucosa","Lumen"],GutAnatomy.anatomyData=null,fetch(url).then(response=>response.json()).then(jsonAnatomy=>{GutAnatomy.anatomyData=jsonAnatomy,GutAnatomy.flatAnatomy=null==jsonAnatomy.children}).catch(err=>console.log("Error laoding anatomy data. "+err))}getAnatomyData(id){id=GutAnatomy.findAnatomyById(id);return console.log("******Anatomy Data: "+id),id}static findAnatomyById(id,anatomy=null){if(null!=(anatomy=null==anatomy?GutAnatomy.anatomyData:anatomy)){if(this.flatAnatomy)return anatomy.find(item=>item.id.toUpperCase()==id.toUpperCase());if(anatomy.doi==id)return anatomy;if(anatomy.children)for(var child of anatomy.children){child=GutAnatomy.findAnatomyById(id,child);if(child)return child}}return null}static findAnatomyByName(name,anatomy=null,exactMatch=!0){var anatomies=[];return GutAnatomy.findAnatomiesByName(name,anatomies,anatomy,exactMatch),anatomies}static findAnatomiesByName(name,anatomies,anatomy,exactMatch){if(null!=(anatomy=null==anatomy?GutAnatomy.anatomyData:anatomy))if(this.flatAnatomy)for(var item of anatomy)this.matchAnatomyName(item,name,exactMatch)&&anatomies.push(item);else if(this.matchAnatomyName(anatomy,name,exactMatch))anatomies.push(anatomy);else if(anatomy.children)for(var child of anatomy.children){child=GutAnatomy.findAnatomiesByName(name,anatomies,child,exactMatch);if(child&&0<child.length)return void anatomies.push(child)}}static matchAnatomyName(anatomy,name,exactMatch=!1){return exactMatch?anatomy.abbreviated_name&&anatomy.abbreviated_name.toUpperCase()==name.toUpperCase()||anatomy.abbreviation&&anatomy.abbreviation.toUpperCase()==name.toUpperCase()||anatomy.displayname&&anatomy.displayname.toUpperCase()==name.toUpperCase()||anatomy.text&&anatomy.text.toUpperCase()==name.toUpperCase():anatomy.abbreviated_name&&anatomy.abbreviated_name.toUpperCase().includes(name.toUpperCase())||anatomy.abbreviation&&anatomy.abbreviation.toUpperCase().includes(name.toUpperCase())||anatomy.displayname&&anatomy.displayname.toUpperCase().includes(name.toUpperCase())||anatomy.text&&anatomy.text.toUpperCase().includes(name.toUpperCase())}static getIntestineLayers(item){var anatomyNode=GutAnatomy.findAnatomyById(item.anatomy[0].id);let layers=[];for(let i=0;i<GutAnatomy.visibleIntstinalLayers.length;i++){var layer=GutAnatomy.visibleIntstinalLayers[i],layerAnatomies=GutAnatomy.findAnatomyByName(layer,anatomyNode,!1);layers[layer]=null!=layerAnatomies&&0<layerAnatomies.length}return layers.Lumen=!0,layers}}import{DisplayPanel}from"./DisplayPanel.js";import{Theme}from"./Theme.js";import{UtilityViewer1D}from"./Utility.js";import{openUberonLink}from"./UberonPanel.js";class Annotation{constructor(type,title,description,pos,link=null){this.type=type,this.title=title,this.description=description,this.pos=Array.isArray(pos)?pos:this.pos=[pos],this.link=link}static compare(a,b){return a.pos[0]>b.pos[0]?1:a.pos[0]<b.pos[0]?-1:"Region"==a.type?"Landmark"==b.type?1:0:"Landmark"!=a.type||"Landmark"==b.type?0:-1}}class AnnotationPanel extends DisplayPanel{constructor(container,parent,model){super(container,parent,model,"annotationBkgColor"),this.populateAnnotations(),this.roi=null}initializePanel(){}initialiseTabCtx(ctx,index,title,x,y,width,height){height-=this.tabHeight;let tab={};tab.index=index,tab.bkgCtx=this.parent.ctx.nested(),tab.bkgCtx.size(width,height).move(x,y+this.tabHeight),tab.bkgCtx.rect(width,height).move(0,0).fill(Theme.currentTheme.annotationBkgColor).radius(Theme.currentTheme.corner).on("mouseleavet",this.removeHighlightAnnotation.bind(this)),tab.ctx=this.parent.ctx.nested(),tab.ctx.size(width,height).move(x,y+this.tabHeight),tab.ctx.lineWidth=1;width=y+this.tabHeight/2+1,height=x+100*index;return tab.tabShape=ctx.path(this.tabShape).fill(Theme.currentTheme.annotationTabColor),tab.tabShape.x(height).cy(width).transform({scaleX:1,scaleY:.7}),tab.tabShape.on("click",this.handleTabClick.bind(this,tab.index)),tab.x=height,tab.y=width,tab.title=ctx.text(title).font(Theme.currentTheme.annotationTabFont).addClass("medium-text"),tab.title.x(height+6).cy(width),tab.title.on("click",this.handleTabClick.bind(this,tab.index)),tab}populateAnnotations(){this.annotationList=new Array;for(var region of this.gutModel.regions){let annotation=new Annotation("Region","Region: "+region.name,this.replaceUndefined(region.description),[region.startPos,region.endPos]);annotation.uberonId=region.uberonId?region.uberonId.replace(":","_"):null,this.annotationList.push(annotation)}for(var landmark of this.gutModel.landmarks)if("pseudo"!=landmark.type){let pos=landmark.position,annotation=(landmark.startPos!=landmark.endPos&&(pos=[landmark.startPos,landmark.endPos]),new Annotation("Landmark","Landmark: "+landmark.title,this.replaceUndefined(landmark.description),pos));annotation.uberonId=landmark.uberonId?landmark.uberonId.replace(":","_"):null,this.annotationList.push(annotation)}this.annotationList.sort(Annotation.compare)}setGutModel(gutModel){this.gutModel=gutModel,this.populateAnnotations()}replaceUndefined=s=>null==s?"":s;getVisibleAnnotations(roi){var startPos=roi.pos,endPos=roi.pos+roi.width;let text=this.ctx.text(" 8888-8888").font(Theme.currentTheme.annotationPosFont).addClass("medium-text");roi=text.bbox(),roi=Math.max(roi.h,12),text.remove(),roi=Math.round((this.ctx.height()-roi+4)/(roi+2));let start=0;for(;this.annotationList[start].pos[0]<startPos;)if(++start>=this.annotationList.length){start--;break}this.annotationList[start].pos[0]>endPos&&(start=Math.max(0,start-1));let end=this.annotationList.length-1;for(;this.annotationList[end].pos[0]>endPos;)end--;var over,over2,available2,n=end-start+1;let startIndex=0,endIndex=0,hasPrev=(roi<n?(over=n-roi,over2=Math.floor(over/2),startIndex=start+over2,endIndex=end-(over-over2)):(over=roi-n,over2=Math.floor(over/2),n=start,available2=this.annotationList.length-end-1,Math.min(n,available2)<=over2?n<available2?(startIndex=0,endIndex=startIndex+roi-1):(endIndex=this.annotationList.length-1,startIndex=endIndex-roi+1):(startIndex=start-over2,endIndex=end+(over-over2))),!1),hasNext=(0<startIndex&&(hasPrev=!0,startIndex++),!1),highlightStart=(endIndex<this.annotationList.length-1&&(hasNext=!0,endIndex--),startIndex=Math.max(0,startIndex),endIndex=Math.min(this.annotationList.length-1,endIndex),0),highlightEnd=-1,visibleList=[],vi=-1;for(let i=startIndex;i<=endIndex;i++){var annotation=this.annotationList[i];visibleList.push(annotation),vi++,i==start&&(highlightStart=vi),i==end&&(highlightEnd=vi)}return highlightEnd<0&&(highlightEnd=visibleList.length-1),{list:visibleList,start:highlightStart,end:highlightEnd,hasPrev:hasPrev,hasNext:hasNext}}insertOrMove(item,list,index){var i;return null==item||index<=(i=list.indexOf(item))||(list.splice(index,0,item),0<=i?(list.splice(i,1),index--):0<index?(list.splice(0,0),index--):list.pop()),index}showAnnotations(roi){let text=this.ctx.text(" 8888-8888").font(Theme.currentTheme.annotationPosFont).addClass("medium-text");var annotation,bbox=text.bbox(),bbh=Math.max(bbox.h,12);text.remove();let visibleAnnotations=this.getVisibleAnnotations(roi),startRegionAnnotation=null,startLandmarkAnnotation=null;for(annotation of this.annotationList)"region"==annotation.type.toLowerCase()&&annotation.pos[0]<roi.pos&&annotation.pos[1]>roi.pos&&(startRegionAnnotation=annotation),"landmark"==annotation.type.toLowerCase()&&annotation.pos[0]<roi.pos&&annotation.pos[1]>roi.pos&&(startLandmarkAnnotation=annotation);visibleAnnotations.end-visibleAnnotations.start+1<visibleAnnotations.list.length&&(visibleAnnotations.start=this.insertOrMove(startRegionAnnotation,visibleAnnotations.list,visibleAnnotations.start)),visibleAnnotations.end-visibleAnnotations.start+1<visibleAnnotations.list.length&&(visibleAnnotations.start=this.insertOrMove(startLandmarkAnnotation,visibleAnnotations.list,visibleAnnotations.start));let y=2+bbh;visibleAnnotations.hasPrev&&((text=this.ctx.text("").addClass("medium-text").y(y)).build("true"),text.tspan("...").font(Theme.currentTheme.annotationFont).x(30),y+=bbh+2);for(let i=0;i<visibleAnnotations.list.length;i++){let annotation=visibleAnnotations.list[i],f1=((text=this.ctx.text("").addClass("medium-text").y(y)).build("true"),Theme.currentTheme.annotationPosFont),f2=Theme.currentTheme.annotationFont,f3=Theme.currentTheme.annotationDescFont;(i<visibleAnnotations.start||i>visibleAnnotations.end)&&(f1=Theme.currentTheme.annotationPosFontBlur,f2=Theme.currentTheme.annotationFontBlur,f3=Theme.currentTheme.annotationDescFontBlur);var pos=annotation.pos[0]+(1<annotation.pos.length?" - "+annotation.pos[1]:""),pos=(text.tspan(pos).font(f1).x(bbox.width+5),text.tspan(annotation.title).font(f2).x(bbox.width+5+10),text.tspan(annotation.description).font(f3).dx(10),this.ctx.width()-14);if(annotation.uberonId){let icon=UtilityViewer1D.showIcon(this.ctx,"colon.svg",14,pos,text.cy(),"Uberon Ontology",1,0).on("click",this.handleUberonLinkClick.bind(this,annotation.uberonId));icon.on("mouseover",this.highlightAnnotation.bind(this,bbox.height+4,text.cy(),icon)),icon.on("mouseout",this.removeHighlightAnnotation.bind(this)),icon.css("cursor","pointer")}y+=bbh+2}visibleAnnotations.hasNext&&((text=this.ctx.text("").addClass("medium-text").y(y)).build("true"),text.tspan("...").font(Theme.currentTheme.annotationFont).x(30),y+=bbh+2)}handleUberonLinkClick(uberonId){openUberonLink(uberonId)}removeHighlightAnnotation(e){this.highlightRect&&(this.highlightRect.remove(),this.highlightRect=null)}highlightAnnotation(h,cy,icon){this.highlightRect&&(this.highlightRect.remove(),this.highlightRect=null),this.highlightRect=this.ctx.rect(this.ctx.width(),h).x(0).cy(cy).fill(Theme.currentTheme.annotationHighlight),icon.front()}setPanelVisibility(visible){visible?(this.ctx.show(),this.bkgCtx.show()):(this.ctx.hide(),this.bkgCtx.hide())}updateRoi(roi){var currentRoi=this.roi;this.roi=roi,null==currentRoi?this.draw():this.redraw()}drawPanel(){this.showAnnotations(this.roi)}}import{Theme}from"./Theme.js";class DisplayPanel extends EventTarget{constructor(container,parent,model,bkgColorName,isSVG=!0){super(),this.container=container,this.parent=parent,this.gutModel=model,this.isAvailable=!1,this.panelWidth=container.clientWidth,this.panelHeight=container.clientHeight,isSVG&&(this.ctx=SVG().addTo(this.container)),this.bkgColorName=bkgColorName,this.straigthCorner=!1,this.initContext(),this.isVisible=!0}initContext(){var bkgColor=Theme.currentTheme[this.bkgColorName]||0;if(this.ctx){var r=Theme.currentTheme.corner;if(this.ctx.size(this.panelWidth,this.panelHeight),this.straigthCorner&&0<r)switch(this.straigthCorner){case"buttom":this.backgroundAdjust=this.ctx.rect(this.panelWidth,r+1).fill(bkgColor).x(0).y(this.panelHeight-r);break;case"top":this.backgroundAdjust=this.ctx.rect(this.panelWidth,r+1).fill(bkgColor).x(0).y(0)}this.background=this.ctx.rect(this.panelWidth,this.panelHeight).move(0,0).fill(bkgColor).radius(r)}else this.container.style.backgroundColor=bkgColor,this.container.style.borderRadius=Theme.currentTheme.corner+"px";0<this.panelWidth&&(this.initializePanel(),this.isAvailable=!0)}adjustContext(){this.ctx&&(this.ctx.size(this.panelWidth,this.panelHeight),this.background.size(this.panelWidth,this.panelHeight),this.backgroundAdjust&&this.backgroundAdjust.size(this.panelWidth,Theme.currentTheme.corner+1))}initializePanel(){}setContainerSize(w,h,x,y){this.container.style.height=h+"px",this.container.style.width=w+"px",null!=y&&(this.container.style.top=y+"px"),null!=x&&(this.container.style.left=x+"px"),this.panelWidth=w,this.panelHeight=h,this.isAvailable?this.adjustContext():this.initContext()}setStraigthCorner(straigthCorner){(this.straigthCorner=straigthCorner)||(this.backgroundAdjust&&this.backgroundAdjust.remove(),this.backgroundAdjust=null)}removeStraigthCorner(){this.setStraigthCorner(!1)}resetPanel(){this.clear(),this.initContext(),this.initializePanel()}redraw(){this.resetPanel(),this.draw()}draw(){0<this.container.clientWidth&&this.drawPanel()}clear(){this.isAvailable=!1,this.ctx?this.ctx.clear():this.container.innerHTML=""}handleTabEvents(e){"tabActivated"===e.type&&this.redraw()}setPanelVisibility(visible){this.isVisible!=visible&&(this.container.style.display=visible?"inherit":"none",this.isVisible=visible)}}import{capitalizeFirst}from"../GCA_Utilities/src/GCA_Utilities.js";import{GutAnatomy}from"./Anatomy.js";class Gut{constructor(id,name,species,level,owner,description="",type="normal"){this.id=id,this.name=name,this.species=species,this.abstractionLevel=level,this.owner=owner,this.description=description,this.regions=[],this.landmarks=[],this.markersList=[],this.subModels=[],this.refModel3D="",this.startPos=Number.MAX_SAFE_INTEGER,this.endPos=0,this.branch=null,this.type=type}static createGutModelFromJson(modelJson){let gut=new Gut(modelJson.id,modelJson.name,modelJson.species,modelJson.level,modelJson.owner,modelJson.description,modelJson.model_type);gut.contact=modelJson.contact,gut.version=modelJson.version+(modelJson.sub_version?"."+modelJson.sub_version:""),gut.formatVersion=modelJson.format_version||"";for(var item of modelJson.regions){var id=item.id,anatomy=item.anatomy?item.anatomy[0]:GutAnatomy.findAnatomyById(id),name=anatomy.abbreviated_name,description=anatomy.text;let color=(null==item.color||null==item.color?anatomy:item).color,externalId=(color=color.replace("0x","#"),item.anatomy[0].external_id);null!=externalId&&null!=externalId||(externalId=anatomy?anatomy.externalId:null);var anatomy=item.paths?1<item.paths.length?2:"GUT_ATLAS_PAT:20"==item.paths[0].toUpperCase()?1:0:0,pos=item.position?item.position[0]:null,start=null==item.start_position||null==item.start_position?pos:item.start_position,pos=null==item.end_position||null==item.end_position?pos:item.end_position;let region=new GutRegion(id,name,description,start,pos,color,externalId);region.setBranch(anatomy),region.layers=GutAnatomy.getIntestineLayers(item),gut.addRegion(region)}for(let item of modelJson.landmarks){let id=item.id,anatomy=item.anatomy?item.anatomy[0]:GutAnatomy.findAnatomyByName(item.name|item.id),name=anatomy.abbreviated_name,description=anatomy.text,color=(null==item.color||null==item.color?anatomy:item).color,externalId=(color=color.replace("0x","#"),item.anatomy[0].external_id),branch=(null!=externalId&&null!=externalId||(externalId=anatomy?anatomy.externalId:null),item.paths?1<item.paths.length?"both":"GUT_ATLAS_PAT:20"==item.paths[0].toUpperCase()?1:0:0),pos=item.position?item.position[0]:null,start=null==item.start_position||null==item.start_position?pos:item.start_position,end=null==item.end_position||null==item.end_position?pos:item.end_position,landmark=(pos=null!=pos||null!=pos?pos:(start+end)/2,new Landmark(id,name,description,pos,start,end,color,item.anatomy,branch,externalId));"pil"==name.toLowerCase()&&landmark.setType("pseudo"),landmark.layers=GutAnatomy.getIntestineLayers(item),gut.addLandmark(landmark)}return gut.landmarks.sort((a,b)=>a.position==b.position?0==a.branch?0==b.branch?0:1:-1:a.position-b.position),gut}static newMethod(item,region){var anatomyNode=GutAnatomy.findAnatomyById(item.anatomy[0].id);region.layers=[];for(let i=0;i<GutAnatomy.visibleIntstinalLayers.length;i++){var layer=GutAnatomy.visibleIntstinalLayers[i],layerAnatomies=GutAnatomy.findAnatomyByName(layer,anatomyNode,!1);region.layers[layer]=layerAnatomies&&0<layerAnatomies.length}region.layers.Lumen=!0}static createGutModelFromXml(modelXmlText){let parser=new DOMParser,model=parser.parseFromString(modelXmlText,"text/xml"),gut=new Gut(model.documentElement.getAttribute("id"),model.documentElement.getAttribute("name"),model.documentElement.getAttribute("species"),model.documentElement.getAttribute("level"),model.documentElement.getAttribute("owner"),model.documentElement.getAttribute("description"));let regions=model.evaluate("/model/regions/region",model,null,XPathResult.ANY_TYPE,null),regionElement=regions.iterateNext();for(;regionElement;){var regionId=regionElement.getAttribute("id"),regionAnatomy=GutAnatomy.findAnatomyById(regionId),regionName=regionElement.getAttribute("name")||capitalizeFirst(regionAnatomy.displayname),regionDescription=regionElement.getAttribute("description")||capitalizeFirst(regionAnatomy.text),regionUberonId=regionElement.getAttribute("uberon")||regionAnatomy.externalid,regionAnatomy=regionElement.getAttribute("color")||regionAnatomy.color,regionStart=parseInt(regionElement.getAttribute("start")),regionEnd=parseInt(regionElement.getAttribute("end"));let region=new GutRegion(regionId,regionName,regionDescription,regionStart,regionEnd,regionAnatomy,regionUberonId);regionId=regionElement.getAttribute("branch");null!=regionId&&region.setBranch(regionId),gut.addRegion(region),regionElement=regions.iterateNext()}let landmarks=model.evaluate("/model/landmarks/landmark",model,null,XPathResult.ANY_TYPE,null),landmarkElement=landmarks.iterateNext();for(;landmarkElement;){let pos=landmarkElement.getAttribute("pos"),start=landmarkElement.getAttribute("start"),end=landmarkElement.getAttribute("end");var color=landmarkElement.getAttribute("color");pos=pos&&parseInt(pos),start=start?parseInt(start):pos,end=end?parseInt(end):pos,pos=pos||(start+end)/2;let landmark=new Landmark(landmarkElement.getAttribute("id"),landmarkElement.getAttribute("title"),landmarkElement.getAttribute("description"),pos,start,end,color,landmarkElement.getAttribute("branch"),landmarkElement.getAttribute("uberon"));color=landmarkElement.getAttribute("type");null!=color&&landmark.setType(color),gut.addLandmark(landmark),landmarkElement=landmarks.iterateNext()}return gut}CreateGutModelRandom(){let gut=new Gut;var n=Math.floor(8*Math.random())+2;let p=1,lm=1;for(let i=1;i<=n;i++){var s=50+Math.floor(151*Math.random()),r=new GutRegion("11"+i,"R"+i,"",p,p+s);if(gut.addRegion(r),(Math.floor(Math.random()*n)+2)%round(.4*n)==1&&80<s&&(r=p+Math.round(.25*s+.5*Math.random(2)*s),m=new Landmark("22"+lm,"LM"+lm,"Landmark"+lm,r),gut.addLandmark(m),lm++),i<n){let m=new Landmark("22"+lm,"LM"+lm,"Landmark"+lm,p+s);gut.addLandmark(m),lm++}p+=s}return gut}getSubModel(branch,startPos=null){if(null!=this.subModels[branch]&&null!=this.subModels[branch])return this.subModels[branch];var originalRegion,region,originalLandmark,branchName=0==branch?"colon":1==branch?"small intestine":"intestine";let subModel=new Gut(this.id+"_"+branchName,this.name+"_"+branchName,this.species,this.level,this.owner,"Submodel for the"+branchName+"of"+this.description);subModel.parent=this,subModel.branch=branch;for(originalRegion of this.regions)originalRegion.branch===branch&&(region=Object.assign({},originalRegion),Object.setPrototypeOf(region,GutRegion.prototype),subModel.addRegion(region));if(0==subModel.regions.length)return null;let posOffset=0;null!=startPos&&(posOffset=startPos-subModel.startPos);for(let region of subModel.regions)region.startPos+=posOffset,region.endPos+=posOffset;for(originalLandmark of this.landmarks)if(originalLandmark.branch===branch||2===originalLandmark.branch){let landmark=Object.assign({},originalLandmark);Object.setPrototypeOf(landmark,Landmark.prototype),landmark.position+=posOffset,landmark.startPos+=posOffset,landmark.endPos+=posOffset,subModel.addLandmark(landmark)}return this.subModels[branch]=subModel}addRegion(region){let i=0;for(;i<this.regions.length&&GutRegion.compare(this.regions[i],region)<0;)i++;this.regions.splice(i,0,region),region.startPos<this.startPos&&(this.startPos=region.startPos),region.endPos>this.endPos&&(this.endPos=region.endPos),this.length=Math.abs(this.endPos-this.startPos)}addLandmark(landmark){this.landmarks.push(landmark)}addMarker(marker){let model=this.parent||this;var markerIndex=model.getMarker(marker.pos);-1==markerIndex?(model.markersList.push(marker),model.markersList.sort(Marker.compare)):marker[markerIndex]=marker}removeMarker(marker){let model=this.parent||this;marker=model.markersList.indexOf(marker);-1!=marker&&model.markersList.splice(marker,marker+1)}getRegion(i){return this.regions[i]}getStartPos(){return this.regions[0].startPos}getEndPos(){return this.regions[this.regions.length-1].endPos}getLength(branch=null){if(0!=branch)return this.length;{let len=0;for(var region of this.regions)0===region.branch&&region.endPos>len&&(len=region.endPos);return len}}getClosestRegionPos(pos){let distance=this.length,closest=this.getStartPos();for(var region of this.regions){var d=Math.abs(region.startPos-pos);distance=d,closest=region.startPos}return this.length-pos<distance?this.length:closest}findRegionIndex(pos,branch=0){let r={main:null,extension:null};for(let i=0;i<this.regions.length;i++)if(pos>=this.regions[i].startPos&&pos<=this.regions[i].endPos)if(0===this.regions[i].branch){if(0===branch)return i;r.main=i}else{if(1===branch)return i;r.extension=i}return 2===branch?r:0===branch?r.extension:r.main}clearMarkers(){this.markersList=[],this.parent&&(this.parent.markersList=[])}getMarker(pos){let model=this;this.parent&&(model=this.parent);for(let i=0;i<model.markersList;i++){if(model.markersList[pos]===pos)return i;if(marker.pos>pos)return-1}return-1}get markers(){return(this.parent||this).markersList}getId=()=>this.id;getName=()=>this.name;getSpecies=()=>this.species;getAbstractionLevel=()=>this.abstractionLevel;getOwner=()=>this.owner}class GutRegion{constructor(id,name,description,start,end,color,uberonId=""){this.id=id,this.uberonId=uberonId,this.name=name,this.description=description,this.startPos=start,this.endPos=end,this.color=color,this.branch=0,this.ontologies=null,this.subRegions=null,this.associatedData=null}setBranch(branch){this.branch=branch}get size(){var len=this.endPos-this.startPos;return Math.abs(len)}static compare(a,b){return a.branch==b.branch?a.startPos-b.startPos:1==a.branch||1!=b.branch&&2==a.branch?1:-1}}class Landmark extends GutRegion{constructor(id,title,description,pos,start,end,color,anatomy,branch=0,uberon=""){super(id,description,description,start,end,color,uberon),this.title=title,this.position=pos,this.startPos=start||pos,this.endPos=end||pos,this.color=color,this.branch=branch,this.type="normal",anatomy=anatomy||GutAnatomy.findAnatomyByName(title),this.anatomy=Array.isArray(anatomy)?anatomy:[anatomy]}setType(type){this.type=type.toLowerCase()}static compare(a,b){return a.position-b.posision}}class Marker{constructor(pos,description="",branch=0){this.pos=pos,this.description=description,this.branch=branch}static compare(a,b){return a.pos-b.pos}}import{clamp}from"../GCA_Utilities/src/GCA_Utilities.js";import{getUberonLink}from"./UberonPanel.js";import{PopupDialog,InfoPopup,MessagePopup,ModelPopup}from"../GCA_Utilities/src/GCA_Dialogs.js";class PopupDialogs{constructor(container){this.container=container||document.body,this.markerDialog=new MarkerDialog(this.container),this.roiDialog=new RoiDialog(this.container),this.regionPopup=new RegionPopup(this.container),this.modelPopup=new ModelPopup(this.container),this.messagePopup=new MessagePopup(this.container)}static instance=null;static initialize(container=null){this.instance||(this.instance=new PopupDialogs(container))}static get markerDialog(){return this.instance.markerDialog}static get roiDialog(){return this.instance.roiDialog}static get regionPopup(){return this.instance.regionPopup}static get modelPopup(){return this.instance.modelPopup}static get messagePopup(){return this.instance.messagePopup}}class MarkerDialog extends PopupDialog{constructor(container){super("marker-dialog","Add/Update a Marker",`	<label for="marker-pos" class="label" >Position:</label>
						<input type="text" name="marker-pos" id="marker-pos" value="123" class="text ui-widget-content ui-corner-all">
						<p class="label">Description:</p>
						<textarea name="description" id="description" class="ui-widget-content ui-corner-all"></textarea>`,container),this.configDialog({autoOpen:!1,hide:"puff",show:"slide",height:200,buttons:{Save:this.save.bind(this),Remove:this.remove.bind(this),Cancel:this.cancel.bind(this)}})}init(){this.description=$("#description")[0],this.pos=$("#marker-pos:first")[0]}save(){this.marker.pos=this.pos.value,this.marker.description=this.description.value,this.saveCallback(this.marker),this.dialog.dialog("close")}remove(){this.description.value="",this.removeCallback(this.marker),this.dialog.dialog("close")}cancel(){this.description.value="",this.dialog.dialog("close")}open(marker=null,saveCallback=null,removeCallback=null){this.marker=marker,null!=saveCallback&&(this.saveCallback=saveCallback),null!=removeCallback&&(this.removeCallback=removeCallback),this.pos.value=null!=marker?marker.pos:"",this.description.value=null!=marker?marker.description:"",this.dialog.dialog("open")}}class RoiDialog extends PopupDialog{constructor(container){super("roi-dialog","Set Region Of Interest",` <div id='roi-dialog-branches'>
							<span class="label">Path:</span> 
	 						<input type="radio" id="roi-branch" name="roi-branch" value="0" tabindex="-1">
							<label for="roi-branch-colon">Colon</label>
							<input type="radio" id="roi-branch" name="roi-branch" value="1" tabindex="-1">
							<label for="roi-branch-ileum">Small intestine</label>
							<p/>
						</div>
						<div class="roi-slidercontainer" style="width:100%; height:20px;">
							<table style="width:100%; border-spacing: 0px;"><tr>
								<td id="roi-width-label" style="width:1%" class="label" >Width:</td>	
								<td style="padding-right:5px">
								  <input type="range" min="1" max="1000" value="200" tabindex="-1" 
									 class="roi-slider" name="roi-adj-slider" id="roi-adj-slider" style="width:100%"></input>
								</td><td style="width:1%">
									<input name="roi-adj-slider-value" id="roi-adj-slider-value" type="NUMBER" min="1"  
										max="1000" step="1" value="200" size="8" 
										style="position:relative; left:0px"></input>
							</td></tr></table>
						</div>
						<br/></p>
						<label id="roi-mid-label" for="roi-mid" class="label" >Middle:</label>
						<input type="text" name="roi-mid" id="roi-mid" size="6" class="text ui-widget-content ui-corner-all">
						&nbsp;&nbsp;
						<label for="roi-cursor" class="label" >Cursor:</label>
						<input type="text" name="roi-cursor" id="roi-cursor" size="6" class="text ui-widget-content ui-corner-all">
						<p/>
					 	<input type="checkbox" id="roi-status" name="roi-status" value="2" title="Check to keep the distal point fixed" tabindex="-1">
						<label for="roi-start" class="label" >Distal:</label>
						<input type="text" name="roi-start" id="roi-start" size="6" class="text ui-widget-content ui-corner-all">
						<p/>
					 	<input type="checkbox" id="roi-status" name="roi-status" value="3"  title="Check to keep the proximal point fixed" tabindex="-1">
						<label for="roi-end" class="label" >Proximal:</label>
						<input type="text" name="roi-end" id="roi-end" size="6" class="text ui-widget-content ui-corner-all">
						`,container),this.configDialog({autoOpen:!1,hide:"puff",show:"slide",width:280,modal:!0,buttons:{Save:this.close.bind(this),Cancel:this.cancel.bind(this)},dialogClass:"no-close"},!1),this.stateIds=["W","M","S","E"]}init(){this.description=$("#description")[0],this.pos=$("#marker-pos:first")[0],this.roiWidthSlider=$("#roi-adj-slider")[0],this.roiWidth=$("#roi-adj-slider-value")[0],this.roiWidthLabel=$("#roi-width-label")[0],this.roiMid=$("#roi-mid")[0],this.roiMidLabel=$("#roi-mid-label")[0],this.roiStart=$("#roi-start")[0],this.roiEnd=$("#roi-end")[0],this.roiCursor=$("#roi-cursor")[0],this.roiBranch=$("input[name='roi-branch']"),this.stateCheckboxes=$("input[name='roi-status']"),this.roiBranchesDiv=$("#roi-dialog-branches")[0];for(var checkbox of this.roiBranch)checkbox.oninput=this.updateRoiBranch.bind(this,checkbox);this.roiWidthSlider.oninput=this.updateRoiSize.bind(this,this.roiWidthSlider),this.roiWidth.oninput=this.updateRoiSize.bind(this,this.roiWidth),this.roiStart.onblur=this.updateStart.bind(this,this.roiStart),this.roiEnd.onblur=this.updateEnd.bind(this,this.roiEnd),this.roiMid.onblur=this.updateMid.bind(this,this.roiMid),this.roiCursor.onblur=this.updateCursor.bind(this,this.roiCursor)}save(){this.updateRoi(this.roi),this.dialog.dialog("close")}cancel(){this.updateRoi(this.savedRoi),this.dialog.dialog("close")}open(roi,updateRoi,branches,minZoomLength=1,maxZoomLength=1e3){this.dialog.tabindex="-1",this.MinZoomLength=minZoomLength,this.MaxZoomLength=maxZoomLength,this.roiWidthSlider.min=this.roiWidth.min=minZoomLength,this.roiWidthSlider.max=this.roiWidth.max=maxZoomLength,this.roi=roi,this.roi.pos=Math.round(this.roi.pos),this.roi.cursorPos=Math.round(this.roi.cursorPos),this.roi.width=Math.round(this.roi.width),this.refresh(this.roi),this.savedRoi=Object.assign({},roi),this.updateRoi=updateRoi,this.maxSize=branches[roi.branchIndex].length,this.roiBranchesDiv.style.display=1<branches.length?"block":"none";var checkbox;for(checkbox of this.stateCheckboxes)checkbox.onclick=this.updateStatus.bind(this,checkbox),checkbox.checked;2=="".length?this.state="":this.setState("WM"),this.dialog.dialog("open")}updateStatus(src){var id=src.value;let state=this.state;switch(this.state){case"WM":state=id<=1?"SE":2==id?"WS":"WE";break;case"SE":state=id<=1?"WM":2==id?"WE":"WS";break;case"WS":state=1==id||2==id?"WM":"SE";break;case"WE":state=1==id||3==id?"WM":"SE"}this.setState(state)}setState(state){this.stateCheckboxes[0].checked="WS"==state||"SE"==state,this.stateCheckboxes[1].checked="WE"==state||"SE"==state,this.roiWidthSlider.disabled="SE"==state,this.roiWidth.disabled="SE"==state,this.roiMid.disabled="WM"!=state,"SE"==state?this.roiWidthLabel.classList.add("roi-dialog-disabled"):this.roiWidthLabel.classList.remove("roi-dialog-disabled"),"WM"==state?this.roiMidLabel.classList.remove("roi-dialog-disabled"):this.roiMidLabel.classList.add("roi-dialog-disabled"),this.state=state}updateRoiBranch(src){src=src.value;src!=this.roi.branchIndex&&(this.roi.branchIndex=src,this.updateRoi(this.roi))}updateRoiSize(src,e){src=src.value;if(!isNaN(src)&&!((src=Math.round(src))<this.MinZoomLength||src>this.MaxZoomLength)){let roi=Object.assign({},this.roi);var endPos=this.roi.pos+this.roi.width;roi.width=Math.round(src),"WM"==this.state?roi.pos=null:"WE"==this.state?(roi.width=Math.min(roi.width,endPos),roi.pos=endPos-roi.width):"SE"==this.state&&(this.setState("WM"),roi.pos=null),this.updateRoi(roi)}}updateStart(src){var endPos;isNaN(src.value)||src.value<0||(src=Number(src.value))!=this.roi.pos&&(src=clamp(src,0,this.maxSize),endPos=this.roi.pos+this.roi.width,"WM"==this.state||"WS"==this.state?(this.setState("WS"),this.roi.pos=src):"WE"!=this.state&&"SE"!=this.state||(this.setState("SE"),this.roi.width=src<endPos?endPos-src:Math.min(this.maxSize-src,this.roi.width),this.roi.pos=src),this.updateRoi(this.roi))}updateEnd(src){isNaN(src.value)||src.value<0||(src=Number(src.value))!=this.roi.pos+this.roi.width&&(src=clamp(src,0,this.maxSize),"WM"==this.state||"WE"==this.state?(this.setState("WE"),this.roi.pos=src-this.roi.width):"WS"!=this.state&&"SE"!=this.state||(this.setState("SE"),src>this.roi.pos?this.roi.width=src-this.roi.pos:this.roi.width=Math.min(src,this.roi.width),this.roi.pos=src-this.roi.width),this.updateRoi(this.roi))}updateMid(src){isNaN(src.value)||src.value<0||(src=Number(src.value))!=this.roi.pos&&(src=clamp(src,0,this.maxSize),this.roi.pos=src-this.roi.width/2,"WM"!=this.state&&this.setState("WM"),this.updateRoi(this.roi))}updateCursor(src){isNaN(src.value)||src.value<0||(src=Number(src.value))!=this.roi.cursorPos&&(this.roi.cursorPos=clamp(src,this.roi.pos,this.roi.pos+this.roi.width),this.updateRoi(this.roi))}refresh(roi){this.roiBranch[roi.branchIndex].checked=!0,this.roiWidthSlider.value=roi.width,this.roiWidth.value=roi.width,this.roiMid.value=roi.pos+Math.round(roi.width/2*10)/10,this.roiStart.value=roi.pos,this.roiEnd.value=roi.pos+roi.width,this.roiCursor.value=roi.cursorPos,this.roi=roi}}class RegionPopup extends InfoPopup{constructor(container){super("region-popup","Gut Region",` <label for="region-name" class="label" >Region:</label>
						<label id="region-name" class="text popup-data"></label>
						<p/>
						<label class="label">Start:</label>
						<label id="region-start" class="text popup-data"></label>
						<p/>
						<label class="label">End:</label>
						<label id="region-end" class="text popup-data"></label>
						<p/>
						<label class="label">UBERON ID:</label>
						<a id="region-uberon" href=""  target="_blank" ></a>`,container)}init(){this.name=$("#region-name")[0],this.start=$("#region-start")[0],this.end=$("#region-end")[0],this.uberon=$("#region-uberon")[0]}showContent(region){this.name.textContent=region.description,this.start.textContent=region.startPos+" mm",this.end.textContent=region.endPos+" mm",this.uberon.textContent=region.uberonId,this.uberon.href=getUberonLink(region.uberonId)}}import{ViewTransform,UtilityViewer1D}from"./Utility.js";import{clamp,Utility}from"../GCA_Utilities/src/GCA_Utilities.js";import{DisplayPanel}from"./DisplayPanel.js";import{Theme}from"./Theme.js";import{PopupDialogs}from"./PopupDialogs.js";const MinZoomLength=1,MaxZoomLength=1e3;class SliderPanel extends DisplayPanel{constructor(container,parent,model,lr=!1){super(container,parent,model,"sliderBkgColor"),this.lr=lr,this.sliderGap=5,this.mode="full"}initializePanel(){this.mode="full"}initializeSliders(){this.sliders=new Array;let mainModel=this.gutModel.getSubModel(0),extModel=this.gutModel.getSubModel(1,0);var l2,model,h2,vGap,ileumModel=extModel,showExpandBtn=("main"==this.mode||"full"==this.mode)&&null!=extModel,showOverlapBtn=null!=extModel,iconSize=showExpandBtn||showOverlapBtn?20:0,offset=5+iconSize,width=this.panelWidth-offset;"main"==this.mode||null==extModel||"overlap"==this.mode?(model="overlap"==this.mode?this.gutModel:mainModel,this.sliders[0]=new Slider(0,this,model,width,this.lr?0:-offset,this.ctx.height()),this.currentSlider=0):(model=mainModel.getLength(),model=(l2=extModel.getLength())<.35*l2?1:.33*model/l2,mainModel.getLength(),extModel.getLength(),l2=width,mainModel.getLength(),extModel.getLength(),model=.5*this.ctx.height(),h2=.48*this.ctx.height(),vGap=Math.min(this.ctx.height()-model-h2,50),this.sliders[0]=new Slider(0,this,mainModel,width,this.lr?0:-offset,model),this.sliders[1]=new Slider(1,this,ileumModel,l2,this.lr?0:-offset,h2,model+vGap)),showOverlapBtn&&this.addControlButtons(width,iconSize,showExpandBtn)}updateRoiSize(src){var maxZoomLength,src=src.value;isNaN(src)||(src=Math.round(src),maxZoomLength=this.sliders[this.currentSlider].gutModel.getLength(),src<MinZoomLength||maxZoomLength<src||(maxZoomLength=this.sliders[this.currentSlider].roiWidth,this.sliders[this.currentSlider].updateRoiWidth(src),maxZoomLength!=this.sliders[this.currentSlider].roiWidth&&this.sliders[this.currentSlider].dispatchRoiChange()))}openRoiDialog(){let roi=this.getRoiExtents(),branches=(roi.branchIndex=this.currentSlider,[]);branches[0]={name:"Colon",length:this.sliders[0].gutModel.getLength()},"full"==this.mode&&(branches[1]={name:"Ileum",length:this.sliders[1].gutModel.getLength()});var maxZoomLength=this.sliders[this.currentSlider].gutModel.getLength();PopupDialogs.roiDialog.open(roi,this.setRoi.bind(this),branches,MinZoomLength,maxZoomLength)}setRoi(roi){this.updateRoi(roi.pos,roi.branchIndex,roi.width,roi.cursorPos),roi.branchIndex!=this.currentSlider&&this.setCurrentSlider(roi.branchIndex);let newRoi=this.getRoiExtents();newRoi.branchIndex=this.currentSlider,PopupDialogs.roiDialog.refresh(newRoi)}addControlButtons(width,size,expandBtn){var width=this.lr?width-1+size/2:1+size/2,gap=(this.panelHeight-3*size)/4;let cy=gap+size/2,img="main"===this.mode^this.lr?"double-arrow-left.svg":"double-arrow-right.svg";expandBtn&&(expandBtn=("main"===this.mode^this.lr?"Show":"Hide")+" small intestine",UtilityViewer1D.showIcon(this.ctx,img,size,width,cy,expandBtn,.75).on("click",this.toggleExtension.bind(this))),cy+=gap+size,img="overlap-view.svg",UtilityViewer1D.showIcon(this.ctx,img,size,width,cy,"Toggle overlap view",.88).on("click",this.toggleOverlap.bind(this)),cy+=gap+size,img="left-right-arrow.svg",UtilityViewer1D.showIcon(this.ctx,img,size,width,cy,"Change ROI",.88).on("click",this.openRoiDialog.bind(this))}drawSliders(slidersStatus){let rois=[],i=(this.currentSlider=0,null!=slidersStatus&&(this.mode=slidersStatus.displayMode,rois=slidersStatus.rois,this.currentSlider=slidersStatus.currentSlider),this.initializeSliders(),0);for(var slider of this.sliders)slider.redraw(rois[i]||null),i++;this.setCurrentSlider(this.currentSlider)}getSlidersStatus(){if(!this.sliders)return null;let rois=[];for(var slider of this.sliders)rois.push(slider.getRoiExtents());return{displayMode:this.mode,currentSlider:this.currentSlider,rois:rois}}getCurrentSlider(){return this.sliders[this.currentSlider]}getRoiExtents(){return this.sliders[this.currentSlider].getRoiExtents()}updateRoi(pos,branchIndex,width=null,cursorPos=null){let newPos=pos;null!=branchIndex&&branchIndex!=this.currentSlider&&("overlap"==this.mode?0<branchIndex&&null!=pos&&(newPos+=this.gutModel.getSubModel(1,0).startPos):("main"==this.mode&&0<branchIndex&&this.toggleExtension(),this.setCurrentSlider(branchIndex)));pos=width||this.sliders[this.currentSlider].getRoiExtents().width;width&&width!=this.sliders[this.currentSlider].getRoiExtents().width&&(this.sliders[this.currentSlider].updateRoiWidth(width),null==newPos&&this.sliders[this.currentSlider].dispatchRoiChange()),null!=newPos&&(branchIndex=cursorPos||newPos+pos/2,this.updateRoiPos(newPos,branchIndex))}updateRoiPos(pos,cursorPos){return this.sliders[this.currentSlider].updateRoiPos(pos,cursorPos)}setRoiPos(pos,cursorPos=null){return this.sliders[this.currentSlider].setRoiPos(pos,cursorPos)}setCursorPos(pos){return this.sliders[this.currentSlider].setCursorPos(pos)}setCurrentSlider(sliderIndex){sliderIndex!=this.currentSlider&&(this.sliders[this.currentSlider].diactivateRoi(),this.currentSlider=sliderIndex),this.sliders[sliderIndex].activateRoi(),this.parent.changeZoomedViewGutModel(this.sliders[sliderIndex].gutModel)}getCurrentGutModel(){return this.sliders[this.currentSlider].gutModel}handleZoomChangeRequest(e){this.sliders[this.currentSlider].handleZoomChangeRequest(e)}toggleExtension(){"main"===this.mode?this.mode="full":(this.mode="main",this.currentSlider=0),this.status=this.getSlidersStatus(),this.redraw()}toggleOverlap(){let status=this.getSlidersStatus();var roiShares;status.displayMode="overlap"===this.mode?"full":"overlap","overlap"===this.mode?(roiShares=SliderPanel.findRoiShares(status.rois[status.currentSlider],this.gutModel),status.currentSlider=roiShares.main>=roiShares.ext?0:1,0<status.currentSlider&&(status.rois[1]=status.rois[0],roiShares=this.gutModel.getSubModel(1).startPos,status.rois[1].pos-=roiShares,status.rois[1].cursorPos-=roiShares)):0<status.currentSlider&&(status.rois[0]=status.rois[1],status.rois[0].pos+=this.getCurrentGutModel().startPos,status.rois[0].cursorPos+=this.getCurrentGutModel().startPos),this.status=status,this.redraw(),this.sliders[this.currentSlider].dispatchRoiChange()}static findRoiShares(roi,model){let extensionMin=roi.pos+roi.width;var region,mainMax=model.getLength(0);for(region of model.regions)1===region.branch&&region.startPos<extensionMin&&(extensionMin=region.startPos);model=Math.max(0,roi.pos+roi.width-Math.max(extensionMin,roi.pos));return{main:Math.max(0,Math.min(mainMax,roi.pos+roi.width)-roi.pos),ext:model}}drawPanel(){this.drawSliders(this.status)}updateSliders(status){this.status=status||this.getSlidersStatus(),this.drawSliders(this.status)}toggleLR(){this.lr=!this.lr,this.redraw()}}class Slider{constructor(index,parent,model,width,hOffset,height,vOffset=0){this.index=index,this.parent=parent,this.gutModel=model,this.lr=parent.lr,this.ctx=this.parent.ctx,this.initializeSlider(width,hOffset,height,vOffset),this.isRoiActive=!1}initializeSlider(width,hOffset,height,vOffset){var posOffset=this.gutModel.getStartPos();this.ctx.on("wheel",this.handleMouseWheel.bind(this)),this.transform=new ViewTransform(width,this.gutModel.getLength(),this.lr,posOffset,10,hOffset),this.setVerticalPositions(height,vOffset)}setVerticalPositions(height,vOffset=0){this.gutThickness=5,this.trackDisplacement=this.gutModel.parent?0:2;let t=this.ctx.text("lp"),space=(this.txtHeight=t.font(Theme.currentTheme.posFont).addClass("small-text").bbox().height-2,Math.max(0,height-this.gutThickness-this.trackDisplacement-4*this.txtHeight-8));0<space&&(adj=Math.min(.5*space,.25*height-this.gutThickness),this.gutThickness+=adj,0<this.trackDisplacement&&(height=Math.min(.1*space,.08*(height-this.trackDisplacement)),this.trackDisplacement+=height,space-=height),space-=adj);var height=this.gutThickness/2,adj=space<10?space-1:9.1*Math.log1p(.3*space),tickHeight=1+.35*adj,s1=.05*adj,adj=.15*adj;this.base=height+this.trackDisplacement+this.txtHeight+tickHeight+s1+vOffset+2,space=Math.max(0,space-2*tickHeight-4*s1-adj),this.base+=space/2,this.baseExtension=this.base-this.trackDisplacement,this.y1PosTick=this.base-height-this.trackDisplacement-tickHeight,this.y2PosTick=this.base+height+tickHeight,this.yPosTxt=this.y1PosTick-s1-this.txtHeight-1,this.yLandmarkTxt=this.y2PosTick+s1+2,this.yRegionTxt=this.yLandmarkTxt+this.txtHeight+adj-2-s1,this.yRegionTxt2=this.yRegionTxt+this.txtHeight+s1-1-s1,this.gutThicknessExtension=this.gutThickness*(this.gutModel.parent?1:.8),t.remove()}redraw(roi){this.drawGut(),null==roi&&((roi={}).pos=this.gutModel.getStartPos(),roi.width=50*Math.round(this.gutModel.length/350),roi.cursorPos=roi.pos+roi.width/2),this.initializeRoi(roi.pos,roi.width),this.initializeMouseover(),this.setCursorPos(roi.cursorPos),this.isRoiActive||(this.roi.hide(),this.cursor.hide())}activateRoi(){this.roi.show(),this.setCursorPos(this.cursorPos),this.cursor.show(),this.isRoiActive=!0}diactivateRoi(){this.roi.hide(),this.cursor.hide(),this.isRoiActive=!1}drawGut(){this.regionNodes=new Array,this.ctx.textAlign="center",this.ctx.lineWidth=1;let i=0;var startPos=this.gutModel.getStartPos(),endPos=this.gutModel.getEndPos(),startX=this.transform.getX(startPos),endX=this.transform.getX(endPos);let x=startX,text=this.ctx.text(startPos+"").font(Theme.currentTheme.posFont).addClass("small-text"),adjust=(this.ctx.line(x,this.y1PosTick,x,this.y2PosTick).stroke(Theme.currentTheme.tickPen),Math.min(text.length()/2,Math.max(0,this.transform.getMargin()-1)));var region,endPos=this.lr?adjust:text.bbox().width-adjust;text.x(x-endPos).y(this.yPosTxt);let regionsTitles=[],positions=[];for(region of this.gutModel.regions){let regionColor=(1===region.branch?Theme.currentTheme.gutColor:Theme.currentTheme.gutExtColor).fill[i%2];var regionOpacity=(1===region.branch?Theme.currentTheme.gutColor:Theme.currentTheme.gutExtColor).opacity,regionOpacity={color:regionColor=null==region.color&&null==region.color?regionColor:Utility.colorBlend(region.color,"#404040",.7),opacity:regionOpacity},regionOpacity={border:Theme.currentTheme.gutColor.border,background:regionOpacity},{title:regionOpacity,regionRect}=this.drawGutRegion(region,regionOpacity,!1);regionsTitles.push(regionOpacity),x=this.transform.getX(region.endPos),this.ctx.line(x,this.y1PosTick,x,this.y2PosTick).stroke(Theme.currentTheme.tickPen),(text=this.ctx.text(region.endPos+"").font(Theme.currentTheme.posFont).addClass("small-text")).cx(x).y(this.yPosTxt),this.regionNodes.push(regionRect.node),i++,positions.push(text)}this.adjustTitles(positions,this.lr,3,!1),adjust=Math.min(text.length()/2,Math.max(0,this.transform.getMargin()-1)),endPos=this.lr?text.bbox().width-adjust:adjust,text.x(x-endPos).y(this.yPosTxt),i=0;let regionsGaps=[];for(let region of this.gutModel.regions)regionsGaps.push(Math.max(0,(this.transform.pos2x(region.size)-regionsTitles[i++].length())/2-3));i=0;var margin=Math.max(0,this.transform.getMargin()-2);for(let region of this.gutModel.regions){var width=this.transform.pos2x(region.size);let adj=0;var gapL,gapR,titleWidth=regionsTitles[i].length();width<titleWidth&&(gapL=this.lr?0==i?margin:regionsGaps[i-1]:i==regionsGaps.length-1?margin:regionsGaps[i+1],gapR=this.lr?i==regionsGaps.length-1?margin:regionsGaps[i+1]:0==i?margin:regionsGaps[i-1],width+2*(gap=Math.min(gapL,gapR))<titleWidth&&(adj=width+gapL+gapR<titleWidth?Math.round((gapL-gapR)/2):(adj=Math.round((titleWidth-width)/2-gap),gapR<gapL?-adj:adj)));let x=this.transform.getX(region.startPos+region.size/2)+adj-titleWidth/2;var width=startX-(this.lr?margin:titleWidth-margin),gap=endX-(this.lr?titleWidth-margin:margin);x=clamp(x,width,gap),regionsTitles[i++].x(x)}for(let title of regionsTitles)title.front();this.adjustTitles2(regionsTitles),this.drawLandmarks()}initializeMouseover(width=10){var d2=Math.min(4,this.gutThickness/2-1),width=width/2,width=clamp(width,2,7);let polygon=[];polygon[0]=[0,d2],polygon[1]=[width,0],polygon[2]=[width,-3],polygon[3]=[-width,-3],polygon[4]=[-width,0],this.cursor=this.ctx.group(),this.cursor.polygon=this.cursor.polygon().plot(polygon).stroke(Theme.currentTheme.cursor).fill(Theme.currentTheme.cursorFill),this.cursor.text=this.cursor.text("x").font(Theme.currentTheme.cursorFont).addClass("small-text");d2=this.cursor.text.bbox().height;this.cursor.text.cx(0).y(-d2-3),this.draggingCursor=this.ctx.group(),this.draggingCursor.polygon=this.draggingCursor.polygon().plot(polygon).stroke(Theme.currentTheme.draggingCursor).fill(Theme.currentTheme.draggingCursorFill),this.draggingCursor.text=this.draggingCursor.text("x").font(Theme.currentTheme.draggingCursorFont).addClass("small-text"),this.draggingCursor.text.cx(0).y(-d2-3),this.draggingCursor.hide()}setCursorPos(pos){var extents=this.getRoiExtents(),pos=clamp(pos,extents.pos,extents.pos+extents.width),extents=(this.cursorPos=pos,this.transform.getX(this.cursorPos));this.updateCursor(extents)}drawLandmarks(){let titles=[],i=0;for(var landmark of this.gutModel.landmarks)if("pseudo"!=landmark.type){let title=this.ctx.text("").y(this.yLandmarkTxt+0);var titleText=title.tspan(landmark.title).dy(title.bbox().height/2),titleText=(UtilityViewer1D.addTooltip(this.ctx,titleText,landmark.description),(landmark.uberonId?title.font(Theme.currentTheme.landmarkFontBold):title.font(Theme.currentTheme.landmarkFont)).addClass("small-text"),landmark.position),x=this.transform.getX(titleText);if(title.cx(x),titles.push(title),0<landmark.size){let landmarkColor=Theme.currentTheme.landmarkColor.fill;var fillColor={color:landmarkColor=null==landmark.color&&null==landmark.color?landmarkColor:Utility.colorBlend(landmark.color,"#404040",.7),opacity:Theme.currentTheme.landmarkColor.opacity},fillColor={border:Theme.currentTheme.landmarkBorderColor,background:fillColor};this.drawGutRegion(landmark,fillColor)}(0<landmark.size||5<Math.abs(this.gutModel.getClosestRegionPos(titleText)-titleText))&&(fillColor=0===landmark.branch?this.base-this.gutThickness/2:this.baseExtension-this.gutThicknessExtension/2,titleText=(this.y1PosTick+fillColor)/2,this.ctx.line(x,titleText,x,this.y2PosTick).stroke(Theme.currentTheme.tickPen)),i++}this.adjustTitles(titles,this.lr)}adjustTitles2(titles,gap=2){let overlap=!1,overlaps=Array(titles.length).fill(!1);for(let i=1;i<titles.length;i++){var s=this.lr?1:-1,x1=titles[i-1].cx()+titles[i-1].length()/2*s;(titles[i].cx()-titles[i].length()/2*s-x1)*s<gap&&!overlaps[i-1]&&(overlap=!0,overlaps[i]=!overlap[i-1])}if(overlap){let row1=[],row2=[];var y=this.yRegionTxt2+1;for(let i=0;i<titles.length;i++)(overlaps[i]?(titles[i].y(y),row1):row2).push(titles[i]);this.adjustTitles(row1,this.lr,gap),this.adjustTitles(row2,this.lr,gap)}}adjustTitles(titles,lr,gap=2,shiftFlag=!0){if(!lr)for(let i=0;i<titles.length/2;i++){var temp=titles[i];titles[i]=titles[titles.length-1-i],titles[titles.length-1-i]=temp}var title,shift,item,margin=Math.max(0,this.transform.getMargin()-gap),limit=titles[titles.length-1].x()+titles[titles.length-1].length+margin;let items=[],i=0;for(title of titles){let item=new Object;item.width=title.length(),item.start=title.cx()-item.width/2,item.start=Math.max(item.start,-margin),item.end=item.start+item.width,item.end>limit&&(item.end=limit,item.start=item.end-item.width),item.titleIndex=i++,item.shift=0,items.push(item)}let hasOverlap=!0;for(this._calculateItemsGaps(items,gap);hasOverlap&&2<titles.length;){if(shiftFlag)for(let i=0;i<items.length;i++)if(items[i].lGap<0&&0<i&&0<items[i-1].lGap&&(shift=Math.min(Math.abs(items[i].lGap),items[i-1].lGap),items[i-1].start-=shift,items[i-1].end-=shift,items[i-1].shift-=shift,this._calculateItemsGaps(items,gap)),items[i].lGap<0&&0<items[i].rGap){let shift=Math.min(Math.abs(items[i].lGap),items[i].rGap);items[i].start+=shift,items[i].end+=shift,items[i-1].shift+=shift,this._calculateItemsGaps(items,gap)}let maxOverlap=null,max=0;for(let i=1;i<items.length;i++){var overlap=items[i-1].end-items[i].start+gap;if(0<overlap&&(null==maxOverlap||overlap>=max)){if(overlap==max&&i<items.length-1){var s1=items[i].start-items[i-1].end+items[i+1].start-items[i].end;if(items[maxOverlap].start-items[maxOverlap-1].end+items[maxOverlap+1].start-items[maxOverlap].end<=s1)continue}maxOverlap=i,max=overlap}}if(null!=maxOverlap){if(shiftFlag){var space=items[maxOverlap].width/2;if(items[maxOverlap-1].lGap<0||items[maxOverlap-1].shift<0){let shift=Math.min(space,Math.max(Math.abs(items[maxOverlap-1].lGap),Math.abs(items[maxOverlap-1].shift)));items[maxOverlap-1].start+=shift,items[maxOverlap-1].end+=shift,items[maxOverlap-1].shift+=shift,this._calculateItemsGaps(items,gap)}if(maxOverlap<items.length-1&&(items[maxOverlap+1].rGap<0||0<items[maxOverlap+1].shift)){let shift=Math.min(space,Math.max(Math.abs(items[maxOverlap+1].rGap),Math.abs(items[maxOverlap+1].shift)));items[maxOverlap+1].start-=shift,items[maxOverlap+1].end-=shift,items[maxOverlap+1].shift-=shift,this._calculateItemsGaps(items,gap)}}items.splice(maxOverlap,1),this._calculateItemsGaps(items,gap)}else hasOverlap=!1}for(item of items)titles[item.titleIndex].cx(item.start+item.width/2),titles[item.titleIndex].isActive=!0;for(let title of titles)title.isActive||title.remove()}_calculateItemsGaps(items,gap){for(let i=0;i<items.length;i++){let item=items[i];item.lGap=Math.min(item.width/2,0<i?item.start-gap-items[i-1].end:0),item.rGap=Math.min(item.width/2,i<items.length-1?items[i+1].start-gap-item.end:0)}}drawGutRegion(region,color,titlePos=null){let thickness=this.gutThickness,y=this.base;1===region.branch&&(thickness=this.gutThicknessExtension,y=this.baseExtension);var x=this.transform.getX(this.lr?region.startPos:region.endPos),width=this.transform.pos2x(region.size),width=this.ctx.rect(width,thickness).x(x).cy(y).fill(color.background).stroke({color:color.border,width:1}).on("click",this.handleRegionClick.bind(this,x)).on("mouseover mousemove",this.handleRegionMouseover.bind(this,x)).on("mouseout",this.handleMouseout.bind(this));if(null!=titlePos){let title=this.ctx.text(" ").font(Theme.currentTheme.regionFont).addClass("medium-text").addClass("clickable-title").on("click",this.handleRegionNameClick.bind(this,region));color=title.tspan(region.name).dy(title.bbox().height/2),x=titlePos?this.yRegionTxt2:this.yRegionTxt;return title.cx(this.transform.getX(region.startPos+region.size/2)).y(x),UtilityViewer1D.addTooltip(this.ctx,color,region.description),{title:title,regionRect:width}}}createRoiPolygon(pos=this.roiPos){var roiShares=SliderPanel.findRoiShares({pos:pos,width:this.roiWidth},this.gutModel),h1=this.lr?0:this.transform.pos2x(this.roiWidth-roiShares.main),h1=0<roiShares.main?this.getPolygon(roiShares.main,this.gutThickness,2,h1):null,v=null==h1?0:(this.gutThickness-this.gutThicknessExtension)/2-this.trackDisplacement,h2=null!=h1&&this.lr?this.transform.pos2x(this.roiWidth-roiShares.ext):0,roiShares=0<roiShares.ext?this.getPolygon(roiShares.ext,this.gutThicknessExtension,2,h2,v):null;if(null==this.roi||null==this.roi)this.roi=this.ctx.group(),null!=h1&&(this.roi.p1=this.roi.polygon().plot(h1).fill(Theme.currentTheme.roiColor).stroke({color:Theme.currentTheme.roiBorder.color,width:Theme.currentTheme.roiBorder.width})),null!=roiShares&&(this.roi.p2=this.roi.polygon().plot(roiShares).fill(Theme.currentTheme.roiColor).stroke({color:Theme.currentTheme.roiBorder.color,width:Theme.currentTheme.roiBorder.width}));else{var h2=null!=this.roi.p1&&null!=this.roi.p1,v=null!=this.roi.p2&&null!=this.roi.p2,c=null!=h1;let d=null!=roiShares;h2==c&&v==d?(h2&&c&&this.roi.p1.plot(h1),!h2&&c&&(this.roi.p1=this.roi.polygon().plot(h1).fill(Theme.currentTheme.roiColor).stroke({color:Theme.currentTheme.roiBorder.color,width:Theme.currentTheme.roiBorder.width})),v&&d&&this.roi.p2.plot(roiShares),!v&&d&&(this.roi.p2=this.roi.polygon().plot(roiShares).fill(Theme.currentTheme.roiColor).stroke({color:Theme.currentTheme.roiBorder.color,width:Theme.currentTheme.roiBorder.width}))):(this.roi.clear(),this.roi.p1=c?this.roi.polygon().plot(h1).fill(Theme.currentTheme.roiColor).stroke({color:Theme.currentTheme.roiBorder.color,width:Theme.currentTheme.roiBorder.width}):null,d?this.roi.p2=this.roi.polygon().plot(roiShares).fill(Theme.currentTheme.roiColor).stroke({color:Theme.currentTheme.roiBorder.color,width:Theme.currentTheme.roiBorder.width}):this.roi.p2=null)}h2=this.transform.getX(pos,this.roiWidth);let y=this.base;if(null==h1)y=this.baseExtension;else if(null!=roiShares){let a=Math.min(this.baseExtension-this.gutThicknessExtension/2,this.base-this.gutThickness/2),b=Math.max(this.baseExtension+this.gutThicknessExtension/2,this.base+this.gutThickness/2);y=(a+b)/2}this.roi.x(h2).cy(y)}getPolygon(width,h,d=2,x=0,y=0){width=Math.max(2*d,Math.round(this.transform.pos2x(width)));let polygon=[];return polygon.push([x,y+d]),polygon.push([x+d,y]),polygon.push([x+width-d,y]),polygon.push([x+width,y+d]),polygon.push([x+width,y+h+d]),polygon.push([x+width-d,y+h+2*d]),polygon.push([x+d,y+h+2*d]),polygon.push([x,y+h+d]),polygon}initializeRoi(pos,width){pos=clamp(pos,this.gutModel.getStartPos(),this.gutModel.getLength()-width),this.roiPos=pos,this.roiWidth=width,this.cursorPos=pos+width/2,this.createRoiPolygon(pos),this.roi.draggable(),this.roi.on("dragmove",this.handleRoiDrag.bind(this)).on("click",this.handleRoiClick.bind(this)).on("wheel",this.handleMouseWheel.bind(this)).on("mouseover mousemove",this.handleRoiMouseover.bind(this)).on("mouseout",this.handleMouseout.bind(this))}setRoiPos(pos,cursorPos=null){pos=clamp(pos,this.gutModel.getStartPos(),this.gutModel.getEndPos()-this.roiWidth);this.createRoiPolygon(pos),this.roiPos=pos,cursorPos&&this.setCursorPos(cursorPos)}updateRoiPos(pos,cursorPos=null){this.setRoiPos(pos),cursorPos=cursorPos||pos+this.roiWidth/2,this.setCursorPos(cursorPos),this.dispatchRoiChange()}updateRoiWidth(width){var posOffset,maxZoomLength=this.gutModel.getLength(),width=clamp(width,MinZoomLength,Math.min(maxZoomLength,this.gutModel.getLength()));(width=Math.round(width))!==this.roiWidth&&(maxZoomLength=(width-this.roiWidth)/2,posOffset=this.gutModel.getStartPos(),maxZoomLength=clamp(Math.round(this.roiPos-maxZoomLength),posOffset,this.gutModel.getLength()-width),this.setRoiPos(maxZoomLength),this.roiWidth=width,(posOffset=clamp(this.cursorPos,this.roiPos,this.roiPos+this.roiWidth))!=this.cursorPos&&this.setCursorPos(posOffset),this.createRoiPolygon())}handleRegionNameClick(region,e){PopupDialogs.regionPopup.open(region,e.target)}handleRegionClick(x,e){x=this.transform.getPos(x+Utility.relativePos(e).x)-this.roiWidth/2;this.isRoiActive||this.parent.setCurrentSlider(this.index),this.updateRoiPos(x)}handleRoiClick(e){e.preventDefault();var x=this.transform.getX(this.roiPos,this.roiWidth),e=(x+=Utility.relativePos(e,!0).x,Math.round(this.transform.getPos(x)));this.setCursorPos(e),this.dispatchRoiChange()}handleRoiDrag(e){e.preventDefault();e=e.detail.box,e=this.transform.getPos(e.x,this.roiWidth),e=clamp(e,this.gutModel.getStartPos(),this.gutModel.getEndPos()-this.roiWidth);this.createRoiPolygon(e),this.setCursorPos(e+(this.cursorPos-this.roiPos)),this.roiPos=e,this.dispatchRoiChange()}handleMouseWheel(e){if(e.preventDefault(),this.isRoiActive){var dw=Math.round(this.transform.x2pos(e.deltaY)),dw=clamp(dw,-5,5);if(1==e.ctrlKey){this.updateRoiWidth(this.roiWidth-dw);e=clamp(this.cursorPos,this.gutModel.getStartPos(),this.gutModel.getEndPos()-this.roiWidth);e!=this.cursorPos&&this.setCursorPos(e)}else{let pos=this.roiPos;e=Math.round(this.roiPos-dw);this.setRoiPos(e),this.setCursorPos(this.roiPos+(this.cursorPos-pos))}this.dispatchRoiChange()}}handleZoomChangeRequest(e){e=Math.round(this.transform.x2pos(e.deltaY)),e=clamp(e,-5,5);this.updateRoiWidth(this.roiWidth-e),this.dispatchRoiChange()}dispatchRoiChange(){var e=new CustomEvent("roi_change",{cancelable:!0,detail:this.getRoiExtents()});this.parent.parent.dispatchEvent(e)}handleRoiMouseover(e){e.preventDefault();var x=this.transform.getX(this.roiPos,this.roiWidth);x+=Utility.relativePos(e,!0).x-4,this.showLastCursor(),this.updateCursor(x)}handleRegionMouseover(regionX,e){e.preventDefault();regionX+=Utility.relativePos(e).x;if(this.isRoiActive)this.showLastCursor();else{let slider=this.parent.getCurrentSlider();this.showLastCursor(slider),slider.cursor.hide()}this.updateCursor(regionX)}showLastCursor(slider=null){this.lastCursorIsShown||(this.lastCursorIsShown=!0,(slider=null==slider?this:slider).updateCursor(slider.cursor.cx(),this.draggingCursor),this.draggingCursor.front())}updateCursor(x,cursor=null){null==cursor&&(cursor=this.cursor);var pos=Math.round(this.transform.getPos(x)),pos=this.transform.clampPos(pos);cursor.text=cursor.text.text(pos+""),cursor.show(),cursor.text.cx(x),cursor.polygon.cx(x);let y=this.base-this.gutThickness/2;null!=this.gutModel.findRegionIndex(pos,2).extension&&(y=this.baseExtension-this.gutThicknessExtension/2);x=this.cursor.text.bbox().height;cursor.y(y-x-4)}handleMouseout(e){if(e.preventDefault(),e.explicitOriginalTarget!==this.roi.node){if(e.explicitOriginalTarget!==this.parent.background.node)for(var node of this.regionNodes)if(e.explicitOriginalTarget===node)return;this.isRoiActive?this.setCursorPos(this.cursorPos):(this.parent.getCurrentSlider().cursor.show(),this.cursor.hide()),this.lastCursorIsShown=!1,this.draggingCursor.hide()}}getRoiExtents(){return{pos:this.roiPos,width:this.roiWidth,cursorPos:this.cursorPos}}getBase(){return this.base}}import{Theme}from"./Theme.js";import{clamp,Utility}from"../GCA_Utilities/src/GCA_Utilities.js";class TabbedPanel{static styleRulesAdded=!1;constructor(container,id,tabNames){this.id=id,this.container=container,this.tabNames=tabNames,this.tabContainers=[],this.tabButtons=[],this.tabListeners=[],this.currentTab=0,this.isAvailable=!1,this.setStyles();var name;for(name of this.tabNames){let tabContainer=Utility.addElement(this.container,"div",this.id+"-"+name,"panel-1D");tabContainer.style.display="none",this.tabContainers.push(tabContainer)}this.panelWidth=this.container.clientWidth,this.panelHeight=this.container.clientHeight,this.isVisible=!0}setContainerSize(w,h,x=0,y=0){this.container.style.height=h+"px",this.container.style.width=w+"px",this.container.style.top=y+"px",this.container.style.left=x+"px",this.isAvailable||(this.init(),this.isAvailable=!0);y=parseFloat(getComputedStyle(this.navBar).fontSize),x=2+Math.max(0,h-400)/500,x=clamp(x,1.5,3)*y-1;this.navBar.style.height=x+"px",this.panelWidth=w,this.panelHeight=h-x}init(){this.navBar=Utility.addElement(this.container,"ul",this.id+"-nav","tabs medium-text",!0);let k=0;for(var name of this.tabNames){let tabButton=Utility.htmlToElem(`<li>${name}</li>`);this.navBar.appendChild(tabButton),this.tabButtons.push(tabButton),tabButton.onclick=this.handleTabClick.bind(this,k),k++}this.tabButtons[this.currentTab].classList.add("current-tab");var font=Theme.currentTheme.coordinateFont;this.navBar.style.color=font.fill,this.tabContainers[this.currentTab].style.display="inherit"}setStyles(){var styles;this.styleRulesAdded||(this.styleRulesAdded=!0,styles=[`margin: 0px;
					padding-left: 10px;
					list-style: none;`,`display: inline-block;	
					padding: 2px 10px 0px;
					cursor: pointer;
					white-space: nowrap;
					border-top-right-radius: 5px;
					border-top-left-radius: 5px;
					border-bottom: 1px solid #133;
					height: calc(100% - 2.8px);
					color: #444; 
					margin: 0px 2px;`,"color: #222;",`color: #222;
					font-weight: bold;
					border-bottom: 1px solid #f6f6f6;`],Utility.addStyle("ul.tabs",styles[0]),this.tabsStyle=Utility.addStyle("ul.tabs li",styles[1]),this.tabsHoverStyle=Utility.addStyle("ul.tabs li:hover",styles[2]),this.tabsActiveStyle=Utility.addStyle("ul.tabs li.current-tab",styles[3]),this.updateTheme())}handleTabClick(k){this.tabButtons[this.currentTab].classList.remove("current-tab"),this.tabContainers[this.currentTab].style.display="none",this.currentTab=k,this.tabButtons[this.currentTab].classList.add("current-tab"),this.tabContainers[this.currentTab].style.display="inherit",this.tabListeners[this.currentTab]&&(k=new CustomEvent("tabActivated",{}),this.tabListeners[this.currentTab].dispatchEvent(k))}setTabListener(tab,listener,callback){(this.tabListeners[tab]=listener).addEventListener("tabActivated",callback.bind(listener))}updateTheme(){this.tabsStyle.style.backgroundColor=Theme.currentTheme.tabColor,this.tabsStyle.style.color=Theme.currentTheme.tabFont.fill,this.tabsActiveStyle.style.backgroundColor=Theme.currentTheme.tabColorActive,this.tabsActiveStyle.style.color=Theme.currentTheme.tabFont.fill,this.tabsActiveStyle.style.borderColor=Utility.colorBlend(Theme.currentTheme.tabColor,Theme.currentTheme.tabColorActive,.3),this.tabsHoverStyle.style.backgroundColor=Utility.colorBlend(Theme.currentTheme.tabColor,Theme.currentTheme.tabColorActive,.3),this.tabsHoverStyle.style.color=Theme.currentTheme.tabFont.fill}setVisible(visible){this.isVisible!=visible&&(this.isVisible=visible,this.container.style.display=this.isVisible?"inherit":"none")}clear(){this.container.innerHTML=""}}import{clamp}from"../GCA_Utilities/src/GCA_Utilities.js";let commonTheme={roiColor:{type:"radial",stops:[{offset:0,color:"#ffffff",opacity:.6},{offset:.45,color:"#ffffff",opacity:.35},{offset:1,color:"#ffffff",opacity:.1}]},roiBorder:{color:"#ff4000",width:2},cursor:{color:"#55A",stroke:1},cursorFill:{color:"#FFF",opacity:.9},draggingCursor:{color:"#888",stroke:1},draggingCursorFill:{color:"#FFF",opacity:.7},zoomCursorColor:{type:"linear",stops:[{offset:0,color:"#aaaaff",opacity:.4},{offset:.5,color:"#aaaaff",opacity:.8},{offset:1,color:"#aaaaff",opacity:.4}]},zoomLayersLine:{color:"#ccc",width:1},landmarkBorderColor:{color:"#aaa",opacity:.9},landmarkColor:{border:"#ddd",fill:"#c5b5b2",opacity:.35},corner:6,margin:5},theme1={bkgColor:"#605555",titleBkgColor:{type:"linear",stops:[{offset:0,color:"#eae8ff"},{offset:1,color:"#aeabbd"}]},sliderBkgColor:{type:"linear",stops:[{offset:0,color:"#f6f4ff"},{offset:1,color:"#d2cfdf"}]},zoomBkgColor:{type:"linear",stops:[{offset:0,color:"#b8b4c8"},{offset:.5,color:"#eee9ff"},{offset:1,color:"#b8b4c8"}]},annotationBkgColor1:{type:"linear",stops:[{offset:0,color:"#bcb8c8"},{offset:.25,color:"#ece8f4"},{offset:.5,color:"#f4f0fa"},{offset:.75,color:"#ece8f4"},{offset:1,color:"#bcb8c8"}],from:[0,0],to:[0,1]},annotationBkgColor:"#ccc8db",annotationHighlight:{color:"#fff",opacity:.4},gutColor:{border:"#000",fill:["#ddd","#777"],opacity:.8},gutExtColor:{border:"#000",fill:["#ffeda5","#a88914"],opacity:.8},tickPen:{color:"black",width:1,linecap:"round"},markerColor:{color:"#F88",opacity:.9},posFont:{fill:"black"},coordinateFont:{fill:"black",weight:"bold"},titleFontNameLarge:{fill:"black",weight:"bold"},titleFontValueLarge:{fill:"blue",weight:"bold"},titleFontName:{fill:"black"},titleFontValue:{fill:"blue"},landmarkFont:{fill:"#33e"},landmarkFontBold:{fill:"#00e",weight:"bold"},regionFont:{fill:"#000"},regionFontZoom:{fill:"#000"},annotationFont:{fill:"black",anchor:"start",weight:"bold"},annotationDescFont:{fill:"#555",anchor:"start",weight:"bold"},annotationPosFont:{fill:"#55F",anchor:"end",weight:"bold"},annotationFontBlur:{fill:"#333",anchor:"start"},annotationDescFontBlur:{fill:"#777",anchor:"start"},annotationPosFontBlur:{fill:"#77F",anchor:"end"},cursorFont:{fill:"#559",size:9,family:"Arial, Helvetica, sans-serif"},draggingCursorFont:{fill:"#99D",size:9,family:"Arial, Helvetica, sans-serif"},tabFont:{fill:"#000"},tabColor:"#aca8bb",tabColorActive:"#d0ccdf"},theme2={bkgColor:"#646890",titleBkgColor:"#f8ffff",sliderBkgColor:"#fff",zoomBkgColor:"#fff",annotationBkgColor:"#fff",annotationHighlight:{color:"#999",opacity:.25},gutColor:{border:"#000",fill:["#ddd","#777"],opacity:.8},gutExtColor:{border:"#000",fill:["#ffeda5","#a88914"],opacity:.8},tickPen:{color:"black",width:1,linecap:"round"},markerColor:{color:"#F88",opacity:.9},posFont:{fill:"black"},coordinateFont:{fill:"black",weight:"bold"},titleFontNameLarge:{fill:"black",weight:"bold"},titleFontValueLarge:{fill:"blue",weight:"bold"},titleFontName:{fill:"black"},titleFontValue:{fill:"blue"},landmarkFont:{fill:"#77f"},landmarkFontBold:{fill:"#00e",weight:"bold"},regionFont:{fill:"#000"},regionFontZoom:{fill:"#000"},annotationFont:{fill:"black",anchor:"start",weight:"bold"},annotationDescFont:{fill:"#555",anchor:"start",weight:"bold"},annotationPosFont:{fill:"#55F",anchor:"end",weight:"bold"},annotationFontBlur:{fill:"#333",anchor:"start"},annotationDescFontBlur:{fill:"#777",anchor:"start"},annotationPosFontBlur:{fill:"#77F",anchor:"end"},cursorFont:{fill:"#66A",size:9,family:"Arial, Helvetica, sans-serif"},draggingCursorFont:{fill:"#AAE",size:9,family:"Arial, Helvetica, sans-serif"},tabFont:{fill:"#000"},tabColor:"#cfcfcf",tabColorActive:"#f6f6f6"};var theme3={bkgColor:"#111",titleBkgColor:{type:"radial",stops:[{offset:0,color:"#666"},{offset:1,color:"#444"}]},sliderBkgColor:{type:"radial",stops:[{offset:0,color:"#282828"},{offset:1,color:"#484848"}]},zoomBkgColor:{type:"radial",stops:[{offset:0,color:"#666"},{offset:.6,color:"#555"},{offset:1,color:"#444"}]},annotationBkgColor1:{type:"linear",stops:[{offset:0,color:"#404040"},{offset:.2,color:"#555555"},{offset:.5,color:"#606060"},{offset:.8,color:"#555555"},{offset:1,color:"#404040"}],from:[0,0],to:[0,1]},annotationBkgColor:"#444",annotationHighlight:{color:"#fff",opacity:.2},gutColor:{border:"#eee",fill:["#c0c0c0","#909090"],opacity:.8},gutExtColor:{border:"#000",fill:["#fae09c","#a66d05"],opacity:.8},tickPen:{color:"#bbb",width:1,linecap:"round"},markerColor:{color:"#F88",opacity:.9},draggingCursor:{color:"#777",stroke:1},draggingCursorFill:{color:"#CCC",opacity:.7},posFont:{fill:"#fff",size:9,family:"Arial, Helvetica, sans-serif"},coordinateFont:{fill:"#fff",size:11,family:"Arial, Helvetica, sans-serif",weight:"bold"},titleFontNameLarge:{fill:"#fff",size:12,family:"Arial, Helvetica, sans-serif",weight:"bold"},titleFontValueLarge:{fill:"#8f9fff",size:12,family:"Arial, Helvetica, sans-serif",weight:"bold"},titleFontName:{fill:"#fff",size:10,family:"Arial, Helvetica, sans-serif"},titleFontValue:{fill:"#fff",size:10,family:"Arial, Helvetica, sans-serif"},landmarkFont:{fill:"#4d94ff",size:9.5,family:"Arial, Helvetica, sans-serif"},landmarkFontBold:{fill:"#66a3ff",size:10,family:"Arial, Helvetica, sans-serif",weight:"bold"},regionFont:{fill:"#fff",size:9},regionFontZoom:{fill:"#fff",size:11,family:"Arial, Helvetica, sans-serif"},annotationFont:{fill:"#fff",size:10,family:"Arial, Helvetica, sans-serif",anchor:"start",weight:"bold"},annotationDescFont:{fill:"#ccc",size:10,family:"Arial, Helvetica, sans-serif",anchor:"start",weight:"bold"},annotationPosFont:{fill:"#bbF",size:10,family:"Arial, Helvetica, sans-serif",anchor:"end",weight:"bold"},annotationFontBlur:{fill:"#ddd",size:10,family:"Arial, Helvetica, sans-serif",anchor:"start"},annotationDescFontBlur:{fill:"#aaa",size:10,family:"Arial, Helvetica, sans-serif",anchor:"start"},annotationPosFontBlur:{fill:"#99F",size:10,family:"Arial, Helvetica, sans-serif",anchor:"end"},cursorFont:{fill:"#BBE",size:9,family:"Arial, Helvetica, sans-serif"},draggingCursorFont:{fill:"#99C",size:9,family:"Arial, Helvetica, sans-serif"},tabFont:{fill:"#fff",size:10,family:"Arial, Helvetica, sans-serif",weight:"bold"},tabColor:"#383838",tabColorActive:"#4a4a4a"};const themes=[theme2,theme1,theme3];class Theme{constructor(container,index){this.ctx=SVG().addTo(container),this.ctx.size(100,20),this.currentThemeIndex=index%themes.length,this.theme=themes[this.currentThemeIndex]}static instance=null;static initialize(container,index=0){this.instance=new Theme(container,index)}static get currentTheme(){return this.instance}static nextTheme(i=null){return i!==this.instance.currentThemeIndex&&(this.instance.currentThemeIndex=(i||this.instance.currentThemeIndex+1)%themes.length,this.instance.theme=themes[this.instance.currentThemeIndex]),this.instance.currentThemeIndex}get bkgColor(){return this.color("bkgColor")}get titleBkgColor(){return this.color("titleBkgColor")}get bkgColor(){return this.color("bkgColor")}get sliderBkgColor(){return this.color("sliderBkgColor")}get zoomBkgColor(){return this.color("zoomBkgColor")}get annotationBkgColor(){return this.color("annotationBkgColor")}get annotationHighlight(){return this.color("annotationHighlight")}get zoomCursorColor(){return this.color("zoomCursorColor")}get zoomLayersLine(){return this.property("zoomLayersLine")}get roiColor(){return this.color("roiColor")}get roiBorder(){return this.color("roiBorder")}get gutColor(){return this.color("gutColor")}get gutExtColor(){return this.color("gutExtColor")}get landmarkColor(){return this.color("landmarkColor")}get corner(){return this.property("corner")}get margin(){return this.property("margin")}get tickPen(){return this.property("tickPen")}get cursor(){return this.property("cursor")}get cursorFill(){return this.property("cursorFill")}get draggingCursor(){return this.property("draggingCursor")}get draggingCursorFill(){return this.property("draggingCursorFill")}get markerColor(){return this.property("markerColor")}get posFont(){return this.property("posFont")}get coordinateFont(){return this.property("coordinateFont")}get titleFontName(){return this.property("titleFontName")}get titleFontNameLarge(){return this.property("titleFontNameLarge")}get titleFontValue(){return this.property("titleFontValue")}get titleFontValueLarge(){return this.property("titleFontValueLarge")}get regionFont(){return this.property("regionFont")}get regionFontZoom(){return this.property("regionFontZoom")}get landmarkFont(){return this.property("landmarkFont")}get landmarkFontBold(){return this.property("landmarkFontBold")}get annotationFont(){return this.property("annotationFont")}get annotationDescFont(){return this.property("annotationDescFont")}get annotationPosFont(){return this.property("annotationPosFont")}get annotationFontBlur(){return this.property("annotationFontBlur")}get annotationDescFontBlur(){return this.property("annotationDescFontBlur")}get annotationPosFontBlur(){return this.property("annotationPosFontBlur")}get cursorFont(){return this.property("cursorFont")}get draggingCursorFont(){return this.property("draggingCursorFont")}get tabFont(){return this.property("tabFont")}get tabColor(){return this.color("tabColor")}get tabColorActive(){return this.color("tabColorActive")}property(name){var prop=this.theme[name];return null==prop?commonTheme[name]:prop}color(name){var step,name=this.property(name);if(null==name)return 0;if(void 0===name.type)return name;let g=this.ctx.gradient(name.type);for(step of name.stops)g.stop(step.offset,step.color,step.opacity);return null!=name.from&&g.from(name.from[0],name.from[1]),null!=name.to&&g.to(name.to[0],name.to[1]),g}gradientColorS3(color,opacity1,opacity2,start,end,mid=(start+end)/2){let g=this.ctx.gradient("linear");mid=1-((mid=clamp(mid,start,end))-start)/Math.abs(end-start);return g.stop(0,color,opacity1),g.stop(mid,color,opacity2),g.stop(1,color,opacity1),g}gradientColorS5(color,opacity1,opacity2,start,end,mid=(start+end)/2){let g=this.gradientColorS3(color,opacity1,opacity2,start,end,mid);mid=1-((mid=clamp(mid,start,end))-start)/Math.abs(end-start);return g.stop(mid/4,color,(opacity1+opacity2)/2),g.stop(1-mid/4,color,(opacity1+opacity2)/2),g}}import{DisplayPanel}from"./DisplayPanel.js";import{Theme}from"./Theme.js";import{PopupDialogs}from"./PopupDialogs.js";class TitlePanel extends DisplayPanel{constructor(container,parent,model){super(container,parent,model,"titleBkgColor")}draw(){var y=this.ctx.height()/2-2;let title=this.ctx.text("Model: ").font(Theme.currentTheme.titleFontName).addClass("large-text").x(4).cy(y);title.build(!0),title.tspan(this.gutModel.name).font(Theme.currentTheme.titleFontValue).addClass("large-text").addClass("clickable-title"),title.on("click",this.handleModelNameClick.bind(this,this.gutModel))}addTitle(name,value,x,y){if(null!=value){let text=this.ctx.text(name+": ").font(Theme.currentTheme.titleFontName).addClass("medium-text").x(x).cy(y);return text.build(!0),text.tspan(value).font(Theme.currentTheme.titleFontValue).addClass("medium-text"),text}}handleModelNameClick(model,e){PopupDialogs.modelPopup.open(model,e.target)}}import{Utility}from"../GCA_Utilities/src/GCA_Utilities.js";import{Theme}from"./Theme.js";import{DisplayPanel}from"./DisplayPanel.js";const UberonUrl="http://purl.obolibrary.org/obo/";class UberonItem{constructor(title,description,pos,link=null){this.title=title,this.description=description,this.pos=pos,this.link=link}static compare(a,b){return a.title>b.title?1:a.title<b.title?-1:0}}function getUberonLink(uberonId){uberonId=uberonId.replace(":","_");return""+(UberonUrl+uberonId)}function openUberonLink(uberonId){uberonId=UberonUrl+uberonId;window.open(uberonId,"_blank","toolbar=yes,resizable=yes,location=yes,scrollbars=yes,status=yes,titlebar=yes")}class UberonPanel extends DisplayPanel{constructor(container,parent){super(container,parent,null,"annotationBkgColor",!1),this.populateUberonTable()}drawPanel(){var tableHead=`<thead><tr>
							<th style="background:${Theme.currentTheme.annotationBkgColor}">Uberon Id</th>
							<th style="background:${Theme.currentTheme.annotationBkgColor}">Description</th></tr></thead>`;let tableBody="<tbody>";var annotation,f1=Theme.currentTheme.annotationPosFont,f2=Theme.currentTheme.annotationFont,idStyle=`color:${f1.fill};`,descStyle=`color:${f2.fill}; font-weight:`+f2.weight;for(annotation of this.uberonTable){var uberonId=annotation.description.replace(":","_"),uberonId=`<a style="${idStyle}" href="${UberonUrl+uberonId}" target="_blank">${annotation.description}</a>`;tableBody=(tableBody=tableBody+"<tr>"+`<td style="${idStyle}">${uberonId}</td>`)+`<td style="${descStyle}">${annotation.title}</td>`+"</tr>"}tableBody+="</tbody>",this.uberonDisplayTable=Utility.htmlToElem(`<div class="tableFixHead"><table class="medium-text">${tableHead}${tableBody}</table></div>`);let wrapper=Utility.addElement(this.container,"div");wrapper.style.marginBottom="2px",wrapper.style.height="calc(100% - 2px)",wrapper.appendChild(this.uberonDisplayTable),this.uberonDisplayTable.style.color=f2.fill}populateUberonTable(){var uberon;this.uberonTable=[];for(uberon of[{title:"digestive system",id:"UBERON:0001007"},{title:"intestine",id:"UBERON:0000160"},{title:"anal canal",id:"UBERON:0000159"},{title:"anus",id:"UBERON:0001245"},{title:"ascending colon",id:"UBERON:0001156"},{title:"caecum",id:"UBERON:0001153"},{title:"colon",id:"UBERON:0001155"},{title:"descending colon",id:"UBERON:0001158"},{title:"descending sigmoid junction",id:"UBERON:8410001"},{title:"duodeno-jejunal junction",id:"UBERON:8410000"},{title:"duodenum",id:"UBERON:0002114"},{title:"hepatic flexure of colon",id:"UBERON:0022277"},{title:"ileocecal valve",id:"UBERON:0000569"},{title:"ileocolic vein",id:"UBERON:0001219"},{title:"ileum",id:"UBERON:0002116"},{title:"inferior mesenteric artery",id:"UBERON:0001183"},{title:"iliac artery",id:"UBERON:0005609"},{title:"internal iliac vein",id:"UBERON:0005609"},{title:"jejunum",id:"UBERON:0002115"},{title:"left colic vein",id:""},{title:"mesenteric lymph node",id:"UBERON:0002509"},{title:"mesentery",id:"UBERON:0002095"},{title:"rectum",id:"UBERON:0001052"},{title:"right colic vein",id:""},{title:"sigmoid colon",id:"UBERON:0001159"},{title:"sigmoid junction",id:""},{title:"splenic flexure of colon",id:"UBERON:0022276"},{title:"superior mesenteric artery",id:"UBERON:0001182"},{title:"terminal ileum",id:"EFO:0005185"},{title:"transverse colon",id:"UBERON:0001157"},{title:"vermiform appendix",id:"UBERON:0001154"},{title:"rectosigmoid junction",id:"UBERON:0036214"},{title:"hepatic vein",id:"UBERON:0001143"},{title:"hepatic artery",id:"UBERON:0001193"},{title:"jejuno-ileal junction",id:"UBERON:8410004"},{title:"left colic artery",id:"UBERON:8410008"},{title:"sigmoid artery",id:"UBERON:0035180"},{title:"ileocolic artery",id:"UBERON:0001197"},{title:"right colic artery",id:"UBERON:8410009"},{title:"superior mesenteric vein",id:"UBERON_0001138"}]){var annotation=new UberonItem(uberon.title,uberon.id,0);this.uberonTable.push(annotation)}this.uberonTable.sort(UberonItem.compare)}}import{clamp,getCurrentScriptPath}from"../GCA_Utilities/src/GCA_Utilities.js";class UtilityViewer1D{static addTooltip(ctx,elm,text){let tooltip=ctx.element("title").words(text);tooltip.addClass("tooltip"),elm.put(tooltip)}static showIcon(ctx,file,size,cx,cy,tooltip=null,scale=.93,margin=null,bkgColor={color:"#ddd",opacity:.58}){size=Math.min(size,Math.min(ctx.height(),ctx.width())-2);let icon=ctx.group();var corner=Math.max(3,.15*size),scale=(margin=null==margin?Math.max(1,(1-scale)*size):margin,icon.rect(size,size).radius(corner).fill(bkgColor),size-2*margin),corner=getCurrentScriptPath(3);return icon.image(corner+"/Icons/"+file).size(scale,scale).move(margin,margin),icon.move(cx-size/2,cy-size/2),null!=tooltip&&UtilityViewer1D.addTooltip(ctx,icon,tooltip),icon}}class ViewTransform{constructor(width,length,lr,posOffset=0,margin=2,xOffset=0){this.width=width,this.length=length,this.lr=lr,this.margin=margin,this.posOffset=posOffset,this.xOffset=xOffset,this.scale=0<length?(width-2*margin)/length:0}pos2x(v){return v*this.scale}x2pos(v){return v/this.scale}getX(pos,elementWidth=0){pos=(pos-this.posOffset+(this.lr?0:elementWidth))*this.scale;return this.lr?this.margin+pos+this.xOffset:this.width-this.margin-pos-this.xOffset}getPos(x,elementWidth=0){return((this.lr?x-this.xOffset:this.width-x-this.xOffset)-this.margin)/this.scale+this.posOffset-(this.lr?0:elementWidth)}getMargin(){return this.margin}setLeft2Right(lr){this.lr=lr}setWidth(width){this.width=width,this.scale=0<this.length?(this.width-2*this.margin)/this.length:0}setPosOffset(posOffset){this.posOffset=posOffset}setXOffset(xOffset){this.xOffset=xOffset}setLength(length){this.length=length,this.scale=(this.width-2*this.margin)/length}clampPos(pos){return clamp(pos,this.posOffset,this.length+this.posOffset)}}import{Marker}from"./GCA_1D_Model.js";import{ViewTransform,UtilityViewer1D}from"./Utility.js";import{clamp,Utility}from"../GCA_Utilities/src/GCA_Utilities.js";import{DisplayPanel}from"./DisplayPanel.js";import{Theme}from"./Theme.js";import{PopupDialogs}from"./PopupDialogs.js";import{GutAnatomy}from"./Anatomy.js";class ZoomPanel extends DisplayPanel{constructor(container,parent,model,lr=!1){super(container,parent,model,"zoomBkgColor"),this.lr=lr,this.ctx.textAlign="center",this.layersVisible=!1,this.xOffset=0,this.transform=new ViewTransform(this.panelWidth-this.xOffset,0,this.lr,0,10,-this.xOffset),this.regionBoxes=new Array,this.markerIcons=new Array,this.currentBranch=0}initializePanel(){this.verticalPositionsSet=!1,this.transform.setWidth(this.panelWidth-this.xOffset),this.setVerticalPositions(this.panelHeight)}setRoi(roi){this.startPos=roi.pos,this.endPos=roi.pos+roi.width,this.cursorPos=clamp(roi.cursorPos,this.startPos,this.endPos),this.transform.setLength(roi.width),this.transform.setPosOffset(roi.pos),this.initializeCoordinates()}setVisibile(visible){visible?(this.ctx.show(),this.bkgCtx.show()):(this.ctx.hide(),this.bkgCtx.hide())}setCurrentBranch(branch){this.currentBranch=branch}setLeft2Right(lr,redraw=!1){this.lr!=lr&&(this.lr=lr,this.transform.setLeft2Right(lr),redraw&&this.redraw())}setVerticalPositions(zoomHeight){if(this.isVisible){let t=this.ctx.text("lp");this.fontHeight=t.font(Theme.currentTheme.regionFontZoom).addClass("large-text").bbox().height-1,this.yPosTxt=this.fontHeight+5,this.yRegionTxt=zoomHeight-this.fontHeight-1,this.yRegionTxt2=this.yRegionTxt-this.fontHeight+1,this.posFontHeight=t.font(Theme.currentTheme.posFont).addClass("medium-text").bbox().height-1,this.y1PosTick=this.yPosTxt+this.posFontHeight+1,this.y2PosTick=this.yRegionTxt-t.font(Theme.currentTheme.landmarkFontBold).addClass("medium-text").bbox().height-this.fontHeight+2,this.yLandmarkTxt=this.y2PosTick+3,t.remove();zoomHeight=.1*zoomHeight;this.gutThickness=this.y2PosTick-this.y1PosTick-zoomHeight,this.gutThicknessExtension=.9*this.gutThickness,this.base=this.y1PosTick+this.gutThickness/2+.7*zoomHeight,this.trackDisplacement=this.base-this.y1PosTick-this.gutThickness/2-10,this.baseExtension=this.base-(this.gutThickness-this.gutThicknessExtension)/2-this.trackDisplacement,this.verticalPositionsSet=!0}}initializeCoordinates(){var startRegionIndex=this.gutModel.findRegionIndex(this.startPos,this.currentBranch),endRegionIndex=this.gutModel.findRegionIndex(this.endPos,this.currentBranch),startRegionIndex=(this.startRegion=this.gutModel.regions[startRegionIndex],this.endRegion=this.gutModel.regions[endRegionIndex],this.gutModel.getLength()),endRegionIndex=(Math.round(this.startPos/startRegionIndex*100),this.startPos-this.startRegion.startPos),startPosRelativePcnt=Math.round(endRegionIndex/this.startRegion.size*100),startRegionIndex=(Math.round(this.endPos/startRegionIndex*100),this.endPos-this.endRegion.startPos),endPosRelativePcnt=Math.round(startRegionIndex/this.endRegion.size*100),startLandmark=this.startRegion.name,endLandmark=this.endRegion.name;this.drawLayersTitles();let startCoordinate=this.ctx.text(startLandmark+":"+Math.round(endRegionIndex)+"mm ("+startPosRelativePcnt+"%)").font(Theme.currentTheme.coordinateFont).addClass("medium-text").y(3),endCoordinate=this.ctx.text(endLandmark+":"+Math.round(startRegionIndex)+"mm ("+endPosRelativePcnt+"%)").font(Theme.currentTheme.coordinateFont).addClass("medium-text").y(3);this.lr?(startCoordinate.x(5),endCoordinate.x(this.panelWidth-10-endCoordinate.length()-this.xOffset)):(startCoordinate.x(this.panelWidth-10-startCoordinate.length()),endCoordinate.x(5+this.xOffset))}drawLayersTitles(){if(this.layersVisible){let maxWidth=0,layersTitles=[];for(let i=0;i<GutAnatomy.visibleIntstinalLayers.length;i++){layersTitles[i]=this.ctx.text(GutAnatomy.visibleIntstinalLayers[i]).font(Theme.currentTheme.posFont).addClass("medium-text");var w=layersTitles[i].bbox().width;w>maxWidth&&(maxWidth=w)}this.xOffset=maxWidth-1+(this.lr?3:-3),this.transform.setXOffset(this.lr?0:-this.xOffset),this.transform.setWidth(this.panelWidth-this.xOffset);var thickness=this.gutThickness,y=this.base,x=this.lr?this.panelWidth-3-this.xOffset:3;for(let i=0;i<layersTitles.length;i++){var lt=thickness/layersTitles.length,ly=y+(i-1)*lt;layersTitles[i].x(x).cy(ly-lt)}}else 0!=this.xOffset&&(this.xOffset=0,this.transform.setWidth(this.panelWidth),this.transform.setXOffset(0))}drawGut(){this.verticalPositionsSet||this.setVerticalPositions(this.panelHeight);let pos=this.startRegion.startPos,x=this.transform.getX(this.startPos);let text=this.ctx.text(Math.round(this.startPos)+"").font(Theme.currentTheme.posFont).addClass("medium-text");this.startPos==pos&&this.ctx.line(x,this.y1PosTick,x,this.y2PosTick).stroke(Theme.currentTheme.tickPen);var adjust=Math.min(text.length()/2,Math.max(0,this.transform.getMargin()-1)),adjust=this.lr?adjust:text.bbox().width-adjust;this.startRegion.endPos-this.startPos>this.transform.x2pos(text.length())?text.x(x-adjust).y(this.yPosTxt):text.remove(),this.regionBoxes=[],this.markerIcons=[],this.overlapVisible=!1;let prevRegionBranch=null;for(let i=0;i<this.gutModel.regions.length;i++){var region=this.gutModel.regions[i];if(!(region.startPos>this.endPos||region.endPos<this.startPos)){let regionColor=(1===region.branch?Theme.currentTheme.gutColor:Theme.currentTheme.gutExtColor).fill[i%2];var regionOpacity=(1===region.branch?Theme.currentTheme.gutColor:Theme.currentTheme.gutExtColor).opacity,regionOpacity={color:regionColor=null==region.color&&null==region.color?regionColor:Utility.colorBlend(region.color,"#404040",.7),opacity:regionOpacity},regionOpacity={border:Theme.currentTheme.gutColor.border,background:regionOpacity},regionOpacity=this.drawGutRegion(region,regionOpacity);(prevRegionBranch=prevRegionBranch||region.branch)!=region.branch&&(this.overlapVisible=!0),this.regionBoxes.push(regionOpacity),pos+=region.size,pos=Math.min(this.endPos,pos),x=this.transform.getX(pos),region.endPos==pos&&this.ctx.line(x,this.y1PosTick,x,this.y2PosTick).stroke(Theme.currentTheme.tickPen),(text=this.ctx.text(Math.round(pos)+"").font(Theme.currentTheme.posFont).addClass("medium-text")).cx(x).y(this.yPosTxt),this.endPos-this.endRegion.startPos>this.transform.x2pos(text.length())?text.cx(x).y(this.yPosTxt):text.remove()}}let titles=[];for(let region of this.regionBoxes)titles.push(region.title);var title,marker,markerIcon,adjust=this.drawLandmarks(),adjust=this.mergeTitles(titles,adjust);for(title of adjust)title.front();this.adjustTitles(adjust);for(marker of this.gutModel.markers){if(marker.pos>this.endPos)break;marker.pos<this.startPos||(markerIcon=this.drawMarker(marker),this.markerIcons.push(markerIcon))}this.changeBranch(this.currentBranch),this.initializeCursor(12,8),this.refreshCursor(this.cursorPos)}mergeTitles(t1,t2){let i=0,j=0,titles=[];for(;i<t1.length&&j<t2.length;)t1[i].bbox().x2>t2[j].bbox().x2!=this.lr?titles.push(t1[i++]):titles.push(t2[j++]);for(;i<t1.length;)titles.push(t1[i++]);for(;j<t2.length;)titles.push(t2[j++]);return titles}adjustTitles(titles,gap=2){let overlap=!1,overlaps=[];for(let i=0;i<titles.length-1;i++){var s=this.lr?1:-1,x1=titles[i].cx()+titles[i].length()/2*s;(titles[i+1].cx()-titles[i+1].length()/2*s-x1)*s<gap&&(overlap=!0,0==i&&(overlaps[i]=!1),overlaps[i+1]=!overlap[i])}if(overlap){var y=this.yRegionTxt2+1;for(let i=1;i<titles.length;i++)overlaps[i]&&titles[i].y(y)}}drawLandmarks(){let titles=[],i=0;for(var landmark of this.gutModel.landmarks)if("pseudo"!=landmark.type){var pos=landmark.position,start=Math.max(landmark.startPos,this.startPos),end=Math.min(landmark.endPos,this.endPos);if(pos>this.endPos){if(landmark.startPos<this.endPos){let titleBox=this.drawLandmarkRegion(landmark,start,end);titleBox&&titles.push(titleBox.title)}}else{if(pos<this.startPos){if(landmark.endPos>this.startPos){let titleBox=this.drawLandmarkRegion(landmark,start,end);titleBox&&titles.push(titleBox.title)}}else{let title=this.ctx.text("").y(this.yLandmarkTxt);var titleText=title.tspan(landmark.title).dy(title.bbox().height/2);UtilityViewer1D.addTooltip(this.ctx,titleText,landmark.description),(landmark.uberonId?title.font(Theme.currentTheme.landmarkFontBold):title.font(Theme.currentTheme.landmarkFont)).addClass("medium-text");let textOffset=0;0!=i&&i!=this.gutModel.landmarks.length-1||(textOffset=title.length()/2-Math.max(0,this.transform.getMargin()),textOffset=Math.max(0,textOffset),textOffset=this.lr?-textOffset:textOffset,0==i&&(textOffset=-textOffset));titleText=this.transform.getX(pos),landmark=this.drawLandmarkRegion(landmark,start,end);if(landmark&&titles.push(landmark.title),title.cx(titleText+textOffset),5<Math.abs(this.gutModel.getClosestRegionPos(pos)-pos)){start=this.y1PosTick;this.ctx.line(titleText,start,titleText,this.y2PosTick).stroke(Theme.currentTheme.tickPen);let text=this.ctx.text(""+pos).font(Theme.currentTheme.posFont).addClass("medium-text");text.cx(titleText).y(this.yPosTxt)}}i++}}return titles}drawLandmarkRegion(landmark,start,end){if(0<landmark.size){let landmarkColor=Theme.currentTheme.landmarkColor.fill;var fillColor={color:landmarkColor=null==landmark.color&&null==landmark.color?landmarkColor:Utility.colorBlend(landmark.color,"#888888",.7),opacity:Theme.currentTheme.landmarkColor.opacity},fillColor={border:Theme.currentTheme.landmarkColor.border,background:fillColor};return this.drawGutRegion(landmark,fillColor,!0)}}drawGutRegion(region,color,innerBorder=!1){let thickness=this.gutThickness,y=this.base;1===region.branch&&(thickness=this.gutThicknessExtension,y=this.baseExtension);var startPos=Math.max(region.startPos,this.startPos),endPos=Math.min(region.endPos,this.endPos),x=this.transform.getX(this.lr?startPos:endPos),width=this.transform.pos2x(endPos-startPos);let regionBox=this.ctx.rect(width,thickness-(innerBorder?2:0)).x(x).cy(y).fill(color.background).stroke({color:color.border,width:1});if(this.layersVisible)for(let i=0;i<GutAnatomy.visibleIntstinalLayers.length-1;i++){var h,lt=thickness/GutAnatomy.visibleIntstinalLayers.length,ly=y+(i-1.5)*lt,layerLine=Theme.currentTheme.zoomLayersLine;region.layers[GutAnatomy.visibleIntstinalLayers[i]]?this.ctx.line(x,ly,x+width,ly).stroke({color:layerLine.color,width:layerLine.width}):(h=lt-2*layerLine.width-2,this.ctx.rect(width-2,h).x(x+1).cy(ly-lt/2).fill({color:layerLine.color,opacity:.9}).stroke({color:layerLine.color,width:1}))}regionBox.on("wheel",this.handleMouseWheel.bind(this)),regionBox.on("click",this.handleRegionClick.bind(this,region));let title=this.ctx.text("").font(Theme.currentTheme.regionFontZoom).addClass("large-text").addClass("clickable-title").on("click",this.handleRegionNameClick.bind(this,region));innerBorder=title.tspan(region.name||region.description).dy(title.bbox().height/2);return title.cx(this.transform.getX((startPos+endPos)/2)).y(this.yRegionTxt),UtilityViewer1D.addTooltip(this.ctx,innerBorder,region.description),{box:regionBox,branch:region.branch,title:title}}setGutModel(gutModel){this.gutModel=gutModel}initializeCursor(w,h,h1=h/3){this.cursor&&this.cursor.clear();var d1=h1,h1=Math.min(h-h1,this.gutThickness/2-1),w=w/2,w=clamp(w,2,10);let polygon=[];polygon[0]=[0,h1],polygon[1]=[w,0],polygon[2]=[w,-d1],polygon[3]=[-w,-d1],polygon[4]=[-w,0],this.cursor=this.ctx.group(),this.cursor.polygon=this.cursor.polygon().plot(polygon).stroke(Theme.currentTheme.cursor).fill(Theme.currentTheme.cursorFill),this.cursor.text=this.cursor.text("x").font(Theme.currentTheme.cursorFont).addClass("small-text");h1=this.cursor.text.bbox().height;this.cursor.text.cx(0).y(-h1-3),this.cursor.draggable(),this.cursor.on("dragmove",this.handleCursorDrag.bind(this))}refreshCursor(pos){var x=Math.round(this.transform.getX(pos));let y=this.base-this.gutThickness/2;null!=this.gutModel.findRegionIndex(pos,2).extension&&(y=this.baseExtension-this.gutThicknessExtension/2);var txtHeight=this.cursor.text.bbox().height;this.cursor.cx(x).y(y-txtHeight-4),this.cursor.text=this.cursor.text.text(Math.round(pos)+""),this.cursor.text.cx(x)}handleCursorDrag(e){e.preventDefault();e=e.detail.box,e=this.transform.getPos(e.x),this.updateCursorPos(e),e={pos:this.startPos,width:this.endPos-this.startPos,cursorPos:this.cursorPos},e=new CustomEvent("zoom_cursor_change",{cancelable:!0,detail:e});this.parent.dispatchEvent(e)}handleMouseWheel(e){e.preventDefault();var displacement=e.deltaY;1==e.ctrlKey?this.dispatchZoomChangeRequest(displacement):this.shiftView(displacement)}shiftView(dx){let dPos=Math.ceil(Math.abs(this.transform.x2pos(dx)));var w;0!=dPos&&(w=this.endPos-this.startPos,w=this.transform.pos2x(w)/w*.2+3,dPos=Math.max(1,Math.round(dPos/w)),dPos=0<dx&&!this.lr||dx<0&&this.lr?Math.min(dPos,this.gutModel.getLength()-this.endPos):-Math.min(dPos,this.startPos),this.startPos+=dPos,this.endPos+=dPos,this.transform.setPosOffset(this.startPos),this.updateCursorPos(this.cursorPos),this.dispatchRegionDraged(),this.redraw())}updateCursorPos(pos){pos=clamp(pos,this.startPos,this.endPos);0!=pos-this.cursorPos&&(this.cursorPos=pos,this.refreshCursor(pos))}updateRoi(roi){this.setRoi(roi),this.redraw()}drawPanel(){this.initializeCoordinates(),this.drawGut()}dispatchRegionDraged(){var e=new CustomEvent("region_dragged",{cancelable:!0,detail:{pos:this.startPos,width:this.endPos-this.startPos,cursorPos:this.cursorPos}});this.parent.dispatchEvent(e)}dispatchZoomChangeRequest(displacement){displacement=new CustomEvent("zoom_change_request",{cancelable:!0,detail:{deltaY:displacement}});this.parent.dispatchEvent(displacement)}toggleLayersVisible(){this.layersVisible=!this.layersVisible,this.redraw()}addMarker(pos,branch){-1==this.gutModel.getMarker(pos)&&(pos=new Marker(pos,"",branch),PopupDialogs.markerDialog.open(pos,this.saveMarker.bind(this),this.removeMarker.bind(this)))}saveMarker(marker){this.gutModel.addMarker(marker);marker=this.drawMarker(marker);this.markerIcons.push(marker)}removeMarker(marker){this.gutModel.removeMarker(marker);let i=-1;for(let k=0;i<this.markerIcons.length;k++)if(this.markerIcons[k].marker===marker){i=k;break}-1!==i&&(this.markerIcons[i].clear(),this.markerIcons[i].remove(),this.markerIcons.splice(i,i+1))}drawMarker(marker){var x=Math.round(this.transform.getX(marker.pos)),y=this.base,p=`M ${x} ${y} L ${x-4} ${y-10} C ${x-4-2} ${y-10-8} ${x+4+2} ${y-10-8} ${x+4} ${y-10} z`;let markerIcon=this.ctx.group();return markerIcon.path(p),markerIcon.circle(3).cx(x).cy(y-10-1).stroke({color:"black",width:1}),markerIcon.fill(Theme.currentTheme.markerColor),markerIcon.stroke({color:"black",width:1}),UtilityViewer1D.addTooltip(this.ctx,markerIcon,"Marker pos "+marker.pos),markerIcon.on("click",this.handleMarkerClick.bind(this,marker)),markerIcon.marker=marker,markerIcon}changeBranch(branch){if(this.currentBranch=branch,this.overlapVisible)if(0===this.currentBranch){for(var markerIcon of this.markerIcons)0===markerIcon.marker.branch&&markerIcon.front();for(var region of this.regionBoxes)0===region.branch&&(region.box.front(),region.title.front())}else{for(let region of this.regionBoxes)0!==region.branch&&(region.box.front(),region.title.front());for(let markerIcon of this.markerIcons)0!==markerIcon.marker.branch&&markerIcon.front()}}toggleBranch(){this.currentBranch=0===this.currentBranch?1:0,this.redraw()}handleBranchClick(){this.toggleBranch()}handleMarkerClick(marker){PopupDialogs.markerDialog.dialog.dialog("isOpen")?PopupDialogs.markerDialog.dialog.dialog("close"):PopupDialogs.markerDialog.open(marker)}handleRegionClick(region,e){Utility.handleClicks(this.handleRegionSingleClick.bind(this),this.handleRegionDblClick.bind(this),region,e)}handleRegionSingleClick(region,e){region=this.getClickPos(region,e),e=this.gutModel.findRegionIndex(region,2);null!=e.extension&&null!=e.main&&this.toggleBranch()}handleRegionDblClick(region,e){e=this.getClickPos(region,e);this.addMarker(e,region.branch)}handleRegionNameClick(region,e){PopupDialogs.regionPopup.open(region,e.target)}getClickPos(region,e){var startPos=Math.max(region.startPos,this.startPos),region=Math.min(region.endPos,this.endPos),x=this.transform.getX(this.lr?startPos:region),e=(x+=Utility.relativePos(e).x,clamp(Math.round(this.transform.getPos(x)),startPos,region));return e}toggleLR(){this.lr=!this.lr,this.transform.setLeft2Right(this.lr),this.redraw()}}export{TitlePanel}from"./core/TitlePanel.js";export{SliderPanel}from"./core/SliderPanel.js";export{ZoomPanel}from"./core/ZoomPanel.js";export{AnnotationPanel}from"./core/AnnotationPanel.js";export{UberonPanel}from"./core/UberonPanel.js";export{Gut,Marker}from"./core/GCA_1D_Model.js";export{Theme}from"./core/Theme.js";export{UtilityViewer1D}from"./core/Utility.js";export{TabbedPanel}from"./core/TabbedPanel.js";export{PopupDialogs}from"./core/PopupDialogs.js";export{GutAnatomy}from"./core/Anatomy.js";import{Utility,clamp,getCurrentScriptPath}from"./modules/GCA_Utilities/src/GCA_Utilities.js";import*as Core from"./modules/core.js";const WidthLimit=800,HeightLimitFullView=245,HeightLimitTopView=115,buttomMargin=3.5;let currentPath=getCurrentScriptPath(1);const AnatomyFile=currentPath+"/gca_anatomy_h_v1.json";Utility.addStylesheet(currentPath+"/src//modules/GCA_Utilities/external/jquery-ui/jquery-ui.min.css"),Utility.addStylesheet(currentPath+"/src/modules/GCA_Utilities/src/GCA_Utilities.css"),Utility.addStylesheet(currentPath+"/src/GCA_1DViewer.css");class Viewer1D extends EventTarget{constructor(container,theme=0,lr=!1){super(),this.lr=lr,this.themeIndex=theme,this.fullView=!0,this.noTitlePanel=!0,this.containersVisible=!0,this.container=Utility.addElement(container,"div","wraper1D","hidden-scroll"),Core.Theme.initialize(this.container,this.themeIndex),Core.PopupDialogs.initialize(this.container),this.margin=5,this.container.style.minWidth=WidthLimit+"px",this.container.style.height="100%",this.container.style.position="relative",this.titlePanelContainer=Utility.addElement(this.container,"div","title-panel","panel-1D"),this.sliderPanelContainer=Utility.addElement(this.container,"div","slider-panel","panel-1D"),this.zoomPanelContainer=Utility.addElement(this.container,"div","zoom-panel","panel-1D"),this.textPanelContainer=Utility.addElement(this.container,"div","text-panel","panel-1D");this.textTabbedPanel=new Core.TabbedPanel(this.textPanelContainer,"text-panel",["Anatomy","Uberon"]),this.hasDisplayed=!1,this.listeners={"1D_roi_changed":[],"1D_model_changed":[],"1D_toggle_full_view":[]}}loadModel(modelFile,modelReadyCallback){this.gutAnatomy?this.loadModelFile(modelFile).then(()=>modelReadyCallback()).catch(err=>console.log(`Error laoding model ${err}.`)):(this.gutAnatomy=new Core.GutAnatomy,this.gutAnatomy.loadJsonAnatomy(AnatomyFile).then(()=>this.loadModelFile(modelFile)).then(()=>modelReadyCallback()).catch(err=>console.log(`Error laoding model ${err}.`)))}loadModelFile(file){let type=(this.file=file).split(".").pop().toUpperCase();let messageDiv=Utility.htmlToElem('<div style=" display:flex; justify-content:center; align-items:center;">Loading model ...</div>');return this.container.appendChild(messageDiv),fetch(this.file).then(response=>{if("XML"===type)return response.text();if("JSON"===type)return response.json();throw"Unknown file type!"}).then(modelText=>{messageDiv.remove(),this.processLoadedModel(modelText,type)}).catch(err=>messageDiv.innerHtml="Error loading model."+err)}addRoiChangeListener(listener,callback){this.addListener("1D_roi_changed",listener,callback)}addModelChangeListener(listener,callback){this.addListener("1D_model_changed",listener,callback)}addFullviewToggleListener(listener,callback){this.addListener("1D_toggle_full_view",listener,callback)}removeListener(listener){let i=this.listeners["1D_roi_changed"].indexOf(listener);-1<i&&this.listeners["1D_roi_changed"].splice(i,1),-1<(i=this.listeners["1D_model_changed"].indexOf(listener))&&this.listeners["1D_model_changed"].splice(i,1),-1<(i=this.listeners["1D_toggle_full_view"].indexOf(listener))&&this.listeners["1D_toggle_full_view"].splice(i,1)}updateRoi(pos,branchIndex,width){null==pos||isNaN(pos)||this.sliderPanel.updateRoi(pos,branchIndex,width)}setCursorPos(pos){null==pos||isNaN(pos)||this.sliderPanel.setCursorPos(pos)}getCurrentRoi(){return this.sliderPanel.getRoiExtents()}changeTheme(index=null){Core.Theme.nextTheme(index),this.textTabbedPanel.updateTheme(),this.redraw()}setFullView(fullView){this.fullView!=fullView&&this.toggleFullView()}addMarker(pos,description,branch){let model=this.gutModel;!(model=branch?this.gutModel.getSubModel(branch):model)||pos<0||pos>model.endPos-model.startPos?console.log(`Invalid pos ${pos} in addMarker.`):(branch=new Marker(pos,description),this.zoomPanel.saveMarker(branch))}setRoi(roi,cursor=null){null!=roi&&this.updateRoi(roi.position,roi.branch,roi.width),null!=cursor&&this.setCursorPos(cursor)}static getMinimumHeight(){return HeightLimitTopView}addListener(event,listener,callback){this.listeners[event].includes(listener)||(this.listeners[event].push(listener),listener.addEventListener(event,callback.bind(listener)))}processLoadedModel(model,type){this.gutModel="XML"===type?Core.Gut.createGutModelFromXml(model):Core.Gut.createGutModelFromJson(model),this.notifyModelChange(),this.createPanels(),new ResizeObserver(this.resize.bind(this)).observe(this.container.parentElement)}createPanels(){this.titlePanel=new Core.TitlePanel(this.titlePanelContainer,this,this.gutModel),this.sliderPanel=new Core.SliderPanel(this.sliderPanelContainer,this,this.gutModel,this.lr),this.zoomPanel=new Core.ZoomPanel(this.zoomPanelContainer,this,this.gutModel,this.lr),this.annotationPanel=new Core.AnnotationPanel(this.textTabbedPanel.tabContainers[0],this,this.sliderPanel.gutModel,Core.Theme.currentTheme.annotationBkgColor,null),this.textTabbedPanel.setTabListener(0,this.annotationPanel,this.annotationPanel.handleTabEvents),this.uberonPanel=new Core.UberonPanel(this.textTabbedPanel.tabContainers[1],this),this.textTabbedPanel.setTabListener(1,this.uberonPanel,this.uberonPanel.handleTabEvents),this.addEventListener("roi_change",this.handleRoiChange.bind(this)),this.addEventListener("region_dragged",this.handleZoomScroll.bind(this)),this.addEventListener("zoom_change_request",this.handleZoomChange.bind(this)),this.addEventListener("zoom_cursor_change",this.handleZoomCursorChange.bind(this))}getHeightLimit(){return this.fullView,this.HeightLimitTopView}displayModel(sliderStatus=null,branch=0){this.hasDisplayed=!0,this.titlePanel.draw();var x=this.titlePanel.panelWidth-this.margin,y=this.titlePanel.panelHeight/2;this.drawControls(this.titlePanel.ctx,x,y,2*this.margin),this.sliderPanel.updateSliders(sliderStatus),null!=sliderStatus&&this.notifyRoiChange(this.sliderPanel.getRoiExtents()),this.currentBranch=branch,this.fullView&&(this.zoomPanel.setLeft2Right(this.lr),this.zoomPanel.setGutModel(this.sliderPanel.getCurrentGutModel()),this.zoomPanel.setCurrentBranch(branch),this.zoomPanel.setRoi(this.sliderPanel.getRoiExtents()),this.zoomPanel.drawGut(),this.annotationPanel.updateRoi(this.sliderPanel.getRoiExtents()),this.uberonPanel.draw())}adjustContainers(){this.container.style.height=this.container.parentElement.clientHeight-50+"px",this.container.style.width=this.container.parentElement.clientWidth-50+"px";var minHeight=this.fullView?HeightLimitFullView:HeightLimitTopView-Math.round(buttomMargin/2);let height=Math.max(minHeight,this.container.parentElement.clientHeight-.5);this.container.style.height=height+"px";var minHeight=Math.max(WidthLimit,this.container.parentElement.clientWidth),topMargin=(this.container.style.width=minHeight+"px",this.fullView||(height*=100/46),this.margin*(this.noTitlePanel?2:3)),th=Math.round(.46*height-topMargin),h1=clamp(Math.round(.1*height),14,60),th=Math.max(74,th-h1),topMargin=(height=Math.round(height),this.topHalfHeight=h1+th+topMargin,Math.max(120,height-this.topHalfHeight-this.margin));this.fullHeight=height;let panelWidth=minHeight-2*this.margin;this.noTitlePanel?(this.titlePanel.setStraigthCorner("buttom"),this.sliderPanel.setStraigthCorner("top")):(this.titlePanel.removeStraigthCorner(),this.sliderPanel.removeStraigthCorner()),this.titlePanel.setContainerSize(panelWidth,h1,this.margin,this.margin),this.noTitlePanel?this.sliderPanel.setContainerSize(panelWidth,th,this.margin,h1+this.margin):this.sliderPanel.setContainerSize(panelWidth,th,this.margin,h1+2*this.margin),this.fullView&&(panelWidth=clamp(.3*minHeight,300,420)-this.margin,this.textTabbedPanel.setContainerSize(panelWidth,topMargin,minHeight-panelWidth-this.margin,this.topHalfHeight),panelWidth=minHeight-panelWidth-3*this.margin,this.zoomPanel.setContainerSize(panelWidth,topMargin,this.margin,this.topHalfHeight),this.annotationPanel.setContainerSize(this.textTabbedPanel.panelWidth,this.textTabbedPanel.panelHeight),this.uberonPanel.setContainerSize(this.textTabbedPanel.panelWidth,this.textTabbedPanel.panelHeight))}toggleNoTitle(){this.noTitlePanel=!this.noTitlePanel,this.redraw()}resize(){var currentRoi=this.sliderPanel.getSlidersStatus();this.hasDisplayed&&(this.clearPanels(),this.setContainersVisibility(!1)),this.adjustContainers(),this.setContainersVisibility(!0),this.displayModel(currentRoi,this.currentBranch)}setContainersVisibility(visible){this.containersVisible!=visible&&(this.titlePanel.setPanelVisibility(visible),this.sliderPanel.setPanelVisibility(visible),visible&&!this.fullView||(this.textTabbedPanel.setVisible(visible),this.zoomPanel.setPanelVisibility(visible)),this.containersVisible=visible)}clearPanels(){this.hasDisplayed&&(this.titlePanel.clear(),this.sliderPanel.clear(),this.zoomPanel.clear(),this.annotationPanel.clear(),this.uberonPanel.clear())}redraw(){var currentRoi=this.sliderPanel.getSlidersStatus();this.clearPanels(),this.zoomPanel.setPanelVisibility(this.fullView),this.textTabbedPanel.setVisible(this.fullView),this.adjustContainers(),this.displayModel(currentRoi,this.currentBranch)}drawControls(ctx,x,cy,gap){var x=x-22,img=this.fullView?"double-arrow-top.svg":"double-arrow-bottom.svg",tooltip=(this.fullView?"Hide":"Show")+" zoom view";Core.UtilityViewer1D.showIcon(ctx,img,22,x,cy,tooltip,.75).on("click",this.toggleFullView.bind(this)),Core.UtilityViewer1D.showIcon(ctx,"theme-change.svg",22,x-=22+gap,cy,"Change theme").on("click",this.toggleTheme.bind(this)),Core.UtilityViewer1D.showIcon(ctx,"left-right.svg",22,x-=22+gap,cy,"Toggle left-to-right display of the model").on("click",this.toggleL2R.bind(this)),this.fullView&&Core.UtilityViewer1D.showIcon(ctx,"colon.svg",22,x-=22+gap,cy,"show layers").on("click",this.toggleLayers.bind(this))}changeZoomedViewGutModel(gutModel){null!=this.zoomPanel&&null!=this.zoomPanel&&this.zoomPanel.isAvailable&&(this.zoomPanel.setGutModel(gutModel),null!=gutModel.branch&&this.zoomPanel.setCurrentBranch(gutModel.branch))}notifyModelChange(){let detail=new Object;detail.start=this.gutModel.getStartPos(),detail.end=this.gutModel.getEndPos(),detail.landmarks=this.gutModel.landmarks;var e=new CustomEvent("1D_model_changed",{cancelable:!0,detail:detail});this.notifyListeners(e)}toggleFullView(ev){ev&&ev.ctrlKey&&ev.shiftKey?this.toggleNoTitle():(this.fullView=!this.fullView,ev=new CustomEvent("1D_toggle_full_view",{cancelable:!0}),this.notifyListeners(ev),this.redraw())}toggleTheme(){this.changeTheme()}toggleL2R(){this.lr=!this.lr,this.sliderPanel.toggleLR(),this.fullView&&this.zoomPanel.toggleLR()}toggleLayers(){this.zoomPanel.toggleLayersVisible()}handleRoiChange(e){e.preventDefault(),this.fullView&&(this.zoomPanel.updateRoi(e.detail),this.annotationPanel.updateRoi(e.detail)),this.notifyRoiChange(e.detail)}handleZoomScroll(e){e.preventDefault(),this.sliderPanel.setRoiPos(e.detail.pos),this.sliderPanel.setCursorPos(e.detail.cursorPos),this.annotationPanel.updateRoi(e.detail),this.notifyRoiChange(e.detail)}handleZoomChange(e){e.preventDefault(),this.sliderPanel.handleZoomChangeRequest(e.detail)}handleZoomCursorChange(e){e.preventDefault(),this.sliderPanel.setCursorPos(e.detail.cursorPos),this.notifyRoiChange(e.detail)}notifyRoiChange(roi){roi.offset=this.sliderPanel.getCurrentGutModel().startPos,roi.branch=this.getActiveBranch();roi=new CustomEvent("1D_roi_changed",{cancelable:!0,detail:roi});this.notifyListeners(roi)}showTooltip(e){var evt=e.detail.evt,x=evt.pageX,evt=evt.pageY;this.tooltip.innerHTML=e.detail.text,this.tooltip.style.display="block",this.tooltip.style.left=x+1+"px",this.tooltip.style.top=evt-32+"px"}hideTooltip(){this.tooltip.style.display="none"}initTooltip(){let div=document.createElement("div");div.id="tooltip",div.style.display="none",div.style.position="absolute",this.container.appendChild(div),this.tooltip=div}notifyListeners(e){for(var listener of this.listeners[e.type])listener.dispatchEvent(e)}getContainer=()=>this.container;getActiveBranch=()=>"overlap"===this.sliderPanel.mode?0==this.zoomPanel.currentBranch?0:2:0==this.sliderPanel.currentSlider?0:1;saveMarkers(name,markers){markers=this.gutModel.markers,"undefined"==typeof Storage&&alert("Markers could not be saved!"),localStorage.setItem("GCA_Markers_"+name,JSON.stringify(markers))}retreiveMarkers(name){"undefined"==typeof Storage&&alert("Markers could not be saved!");name=localStorage.getItem("GCA_Markers_"+name);this.gutModel.markersList=name?JSON.parse(name):null,this.zoomPanel.redraw()}clearMarkers(name){"undefined"==typeof Storage&&localStorage.getItem("GCA_Markers_"+name)&&localStorage.removeItem(name),this.gutModel.clearMarkers(),this.zoomPanel.redraw()}}export{PopupDialog,InfoPopup,MessagePopup,ModelPopup,clamp,capitalizeFirst,Utility,Sidebar,getCurrentScriptPath,GutAnatomy,AnnotationPanel,DisplayPanel,Gut,GutRegion,Landmark,Marker,PopupDialogs,SliderPanel,TabbedPanel,Theme,TitlePanel,UberonPanel,openUberonLink,getUberonLink,ViewTransform,UtilityViewer1D,ZoomPanel,Viewer1D};
